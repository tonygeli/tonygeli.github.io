<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>LILAIQUN</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="LILAIQUN"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LILAIQUN"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="LILAIQUN"><meta property="og:url" content="https://tonygeli.github.io/"><meta property="og:site_name" content="LILAIQUN"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://tonygeli.github.io/img/og_image.png"><meta property="article:author" content="Tonygeli"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://tonygeli.github.io"},"headline":"LILAIQUN","image":["https://tonygeli.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Tonygeli"},"publisher":{"@type":"Organization","name":"LILAIQUN","logo":{"@type":"ImageObject","url":"https://tonygeli.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="LILAIQUN" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-28T09:50:03.000Z" title="2021/7/28 下午5:50:03">2021-07-28</time>发表</span><span class="level-item"><time dateTime="2021-07-28T09:50:03.000Z" title="2021/7/28 下午5:50:03">2021-07-28</time>更新</span><span class="level-item">1 小时读完 (大约9168个字)</span></div></div><div class="content"><p>[toc]</p>
<p>1、自我介绍，项目介绍，遇到的难点？产生原因？如何解决？</p>
<h3 id="2、HashMap1-8与1-7区别？ConcurrentHashMap实现原理-？"><a href="#2、HashMap1-8与1-7区别？ConcurrentHashMap实现原理-？" class="headerlink" title="2、HashMap1.8与1.7区别？ConcurrentHashMap实现原理 ？"></a>2、HashMap1.8与1.7区别？ConcurrentHashMap实现原理 ？</h3><p>HashMap</p>
<p><strong>组成差别</strong><br>1.7:数组+单链表<br>1.8:数据+单链表+红黑树<br><strong>链表存放差别：</strong><br>出现哈希冲突时：<br>1.7直接把数据存放在链表，再无其它操作<br>1.8把数据存放在链表，链表长度超过8就转红黑树<br><strong>扩容差别：</strong><br>1.7扩容条件是数组大于阈值且存在哈希冲突时扩容<br>1.8扩容条件是数组长度大于阈值或链表转红黑树时且数组元素小于64时扩容<br><strong>插值方法：</strong><br>1.7用的是头插法，(在链表头部插入新值)，弊端：可能造成逆序死循环<br>1.8用的是尾插法可避免上面的问题</p>
<p>ConcurrentHashMap采用了非常精妙的”分段锁”策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Segment&lt;K,V&gt;[] segments;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Segment</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span>;</span><br><span class="line"><span class="comment">// 一个Segment维护着一个HashEntry数组</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity,<span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> </span><br><span class="line">  <span class="comment">//MAX_SEGMENTS 为1&lt;&lt;16=65536，也就是最大并发数为65536</span></span><br><span class="line">  <span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">    concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line">	<span class="comment">//2的sshif次方等于ssize，例:ssize=16,sshift=4;ssize=32,sshif=5</span></span><br><span class="line">	<span class="type">int</span> <span class="variable">sshift</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//ssize 为segments数组长度，根据concurrentLevel计算得出</span></span><br><span class="line">	<span class="type">int</span> <span class="variable">ssize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line"> 	 ++sshift;</span><br><span class="line">  	ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Segment数组的大小ssize是由concurrentLevel来决定的，但是却不一定等于concurrentLevel，ssize一定是大于或等于concurrentLevel的最小的2的次幂。比如：默认情况下concurrentLevel是16，则ssize为16；若concurrentLevel为14，ssize为16；若concurrentLevel为17，则ssize为32。</strong></p>
<h3 id="3、jvm类加载器，自定义类加载器，双亲委派机制，优缺点，tomcat类加载机制"><a href="#3、jvm类加载器，自定义类加载器，双亲委派机制，优缺点，tomcat类加载机制" class="headerlink" title="3、jvm类加载器，自定义类加载器，双亲委派机制，优缺点，tomcat类加载机制?"></a>3、jvm类加载器，自定义类加载器，双亲委派机制，优缺点，tomcat类加载机制?</h3><p>避免类的重复加载， 确保一个类的全局唯一性Java 类随着它的类加载器一起具备了一种带<strong>有优先级的层级关系</strong>， 通过这种层级关系可以避免类的重复加载， 当父亲已经加载了该类时， 就没有必要子ClassLoader 再加载一次</p>
<p>Tomcat各个web应用自己的类加载器(WebAppClassLoader)会优先加载，加载不到时再交给commonClassLoader走双亲委托。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExtClassLoader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AppClassLoader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二者同时继承了 URLClassLoader ，继承关系如下：</p>
<p>Tomcat 自己实现了自己的类加载器 WebAppClassLoader。</p>
<ol>
<li>先在本地cache查找该类是否已经加载过，看看 Tomcat 有没有加载过这个类。</li>
<li>如果Tomcat 没有加载过这个类，则从系统类加载器的cache中查找是否加载过。</li>
<li>如果没有加载过这个类，尝试用ExtClassLoader类加载器类加载，重点来了，这里并没有首先使用 AppClassLoader 来加载类。这个Tomcat 的 WebAPPClassLoader 违背了双亲委派机制，直接使用了 ExtClassLoader来加载类。这里注意 ExtClassLoader 双亲委派依然有效，ExtClassLoader 就会使用 Bootstrap ClassLoader 来对类进行加载，保证了 Jre 里面的核心类不会被重复加载。 比如在 Web 中加载一个 Object 类。WebAppClassLoader → ExtClassLoader → Bootstrap ClassLoader，这个加载链，就保证了 Object 不会被重复加载。</li>
<li>如果 BoostrapClassLoader，没有加载成功，就会调用自己的 findClass 方法由自己来对类进行加载，findClass 加载类的地址是自己本 web 应用下的 class。</li>
<li><strong>加载依然失败，才使用 AppClassLoader 继续加载。</strong></li>
<li>都没有加载成功的话，抛出异常。</li>
</ol>
<p>总结一下以上步骤，WebAppClassLoader 加载类的时候，故意打破了JVM 双亲委派机制，绕开了 AppClassLoader，直接先使用 ExtClassLoader 来加载类。</p>
<ul>
<li>保证了基础类不会被同时加载。</li>
<li>又保证了在同一个 Tomcat 下不同 web 之间的 class 是相互隔离的。</li>
</ul>
<h3 id="5、cms收集器过程，g1收集器原理，怎么实现可预测停顿的，region的大小结构？"><a href="#5、cms收集器过程，g1收集器原理，怎么实现可预测停顿的，region的大小结构？" class="headerlink" title="5、cms收集器过程，g1收集器原理，怎么实现可预测停顿的，region的大小结构？"></a>5、cms收集器过程，g1收集器原理，怎么实现可预测停顿的，region的大小结构？</h3><p>CMS 处理过程有七个步骤：</p>
<ol>
<li>初始标记(CMS-initial-mark) ,会导致stw;</li>
<li>并发标记(CMS-concurrent-mark)，与用户线程同时运行；</li>
<li>预清理（CMS-concurrent-preclean），与用户线程同时运行；</li>
<li>可被终止的预清理（CMS-concurrent-abortable-preclean） 与用户线程同时运行；</li>
<li>重新标记(CMS-remark) ，会导致swt；</li>
<li>并发清除(CMS-concurrent-sweep)，与用户线程同时运行；</li>
<li>并发重置状态等待下次CMS的触发(CMS-concurrent-reset)，与用户线程同时运行； 其运行流程图如下所示：</li>
</ol>
<h3 id="6、内存溢出，内存泄漏遇到过吗？什么场景产生的，怎么解决的？"><a href="#6、内存溢出，内存泄漏遇到过吗？什么场景产生的，怎么解决的？" class="headerlink" title="6、内存溢出，内存泄漏遇到过吗？什么场景产生的，怎么解决的？"></a>6、内存溢出，内存泄漏遇到过吗？什么场景产生的，怎么解决的？</h3><p>引起内存溢出的原因有很多种，常见的有以下几种：<br>　　1.内存中加载的数据量过于庞大，如一次从数据库取出过多数据；<br>　　2.集合类中有对对象的引用，使用完后未清空，使得JVM不能回收；<br>　　3.代码中存在死循环或循环产生过多重复的对象实体；<br>　　4.使用的第三方软件中的BUG；<br>　　5.启动参数内存值设定的过小；</p>
<p>【情况一】：<br><code>java.lang.OutOfMemoryError:Javaheapspace</code>：这种是java堆内存不够，一个原因是真不够（如递归的层数太多等），另一个原因是程序中有死循环；<br>　　如果是java堆内存不够的话，可以通过调整JVM下面的配置来解决：<br>　　-Xms3062m<br>　　-Xmx3062m</p>
<p>【情况二】<br><code>java.lang.OutOfMemoryError:GCoverheadlimitexceeded</code><br>　　【解释】：JDK6新增错误类型，当GC为释放很小空间占用大量时间时抛出；一般是因为堆太小，导致异常的原因，没有足够的内存。<br>　　【解决方案】：<br>　　1、查看系统是否有使用大内存的代码或死循环；<br>　　2、通过添加JVM配置，来限制使用内存：<br>　　-XX:-UseGCOverheadLimit</p>
<p>【情况五】：<br>　　java.lang.OutOfMemoryError:unabletocreatenewnativethread<br>　　【原因】：Stack空间不足以创建额外的线程，要么是创建的线程过多，要么是Stack空间确实小了。<br>　　【解决】：由于JVM没有提供参数设置总的stack空间大小，但可以设置单个线程栈的大小；而系统的用户空间一共是3G，<br>　　　　　　　除了Text&#x2F;Data&#x2F;BSS&#x2F;MemoryMapping几个段之外，Heap和Stack空间的总量有限，是此消彼长的。因此遇到这个错误，<br>　　　　　　  可以通过两个途径解决：1.通过-Xss启动参数减少单个线程栈大小，这样便能开更多线程（当然不能太小，太小会出现StackOverflowError）；<br>　　　　　　　　　　　　　　　　　　2.通过-Xms-Xmx两参数减少Heap大小，将内存让给Stack（前提是保证Heap空间够用）。</p>
<p>【情况六】：<br>　　java.lang.StackOverflowError<br>　　【原因】：这也内存溢出错误的一种，即线程栈的溢出，要么是方法调用层次过多（比如存在无限递归调用），要么是线程栈太小。<br>　　【解决】：优化程序设计，减少方法调用层次；调整-Xss参数增加线程栈大小</p>
<p>Java都采用了“可达性分析”算法来进行内存回收，原理是：会有几个引用作为root节点，对于任意对象来说，如果从root层层遍历，如果找不到对于他的引用链，那么这个对象就被标记为无用，就会在gc时被销毁。</p>
<h3 id="7、volatile的原理？synchronized和重入锁实现原理以及区别？"><a href="#7、volatile的原理？synchronized和重入锁实现原理以及区别？" class="headerlink" title="7、volatile的原理？synchronized和重入锁实现原理以及区别？"></a>7、volatile的原理？synchronized和重入锁实现原理以及区别？</h3><p>volatile保证<strong>可见性</strong>、<strong>防止指令重排</strong>，不保证<strong>原子性</strong>。在JVM底层volatile是采用“内存屏障”来实现的。</p>
<h3 id="8、redis字符串实现，sds和c字符串区别？"><a href="#8、redis字符串实现，sds和c字符串区别？" class="headerlink" title="8、redis字符串实现，sds和c字符串区别？"></a>8、redis字符串实现，sds和c字符串区别？</h3><p><strong>1、在求长度的时候</strong>   C字符串 O(n)  SDS只需要访问len属性即可 时间复杂度O(1).<br><strong>2、缓冲区溢出问题</strong>   C字符串会修改与它相邻 SDS 这里会先根据空间是否够用,实际空间长度为 free + len + 1<br><strong>3、字符串内存分配</strong>   SDS 内部使用两种机制 惰性空间释放跟空间预分配<br>空间预分配：这里SDS&lt;1M的时候是 free &#x3D; len,若SDS&#x3D;6byte 则空间为 6byte + 6byte + 1byte<br>大于1M的时候free &#x3D; 1M, 若SDS长度为60M 则实际空间为 60M + 1M + 1byte<br>惰性空间释放  不立即使用内存重新分配来回收缩短后的字节，而是通过free记录起来，以供后续使用，SDS也提供了相应的API，防止惰性空间导致内存浪费。</p>
<h3 id="9、redis集群，为什么是16384个slot？选举过程，会有脑裂问题么，raft算法，优缺点？"><a href="#9、redis集群，为什么是16384个slot？选举过程，会有脑裂问题么，raft算法，优缺点？" class="headerlink" title="9、redis集群，为什么是16384个slot？选举过程，会有脑裂问题么，raft算法，优缺点？"></a>9、redis集群，为什么是16384个slot？选举过程，会有脑裂问题么，raft算法，优缺点？</h3><p>(1)如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。<br>如上所述，在消息头中，最占空间的是<code>myslots[CLUSTER_SLOTS/8]</code>。<br>当槽位为65536时，这块的大小是:<br><code>65536÷8÷1024=8kb</code><br>因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。<br>(2)redis的集群主节点数量基本不可能超过1000个。<br>如上所述，集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者，不建议redis cluster节点数量超过1000个。<br>那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。<br>(3)槽位越小，节点少的情况下，压缩比高<br>Redis主节点的配置信息中，它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中，会对bitmap进行压缩，但是如果bitmap的填充率slots &#x2F; N很高的话(N表示节点数)，bitmap的压缩率就很低。<br>如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。</p>
<h3 id="10、redis有序集合怎么实现的，跳表是什么？往跳表添加一个元素的过程获取分数的时间复杂度，为什么不用红黑树，红黑树有什么特点，左旋右旋操作？"><a href="#10、redis有序集合怎么实现的，跳表是什么？往跳表添加一个元素的过程获取分数的时间复杂度，为什么不用红黑树，红黑树有什么特点，左旋右旋操作？" class="headerlink" title="10、redis有序集合怎么实现的，跳表是什么？往跳表添加一个元素的过程获取分数的时间复杂度，为什么不用红黑树，红黑树有什么特点，左旋右旋操作？"></a>10、redis有序集合怎么实现的，跳表是什么？往跳表添加一个元素的过程获取分数的时间复杂度，为什么不用红黑树，红黑树有什么特点，左旋右旋操作？</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Redis使用了两种数据结构来共同实现有序集合</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span>&#123;</span></span><br><span class="line">     <span class="comment">//跳跃表</span></span><br><span class="line">     zskiplist *zsl;		<span class="comment">// 范围操作 查找O(logN)</span></span><br><span class="line">     <span class="comment">//字典</span></span><br><span class="line">     dict *dice;				<span class="comment">// 无序保存元素 查找O(1) </span></span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure>

<p>当有序集合对象同时满足以下两个条件时，对象使用 <code>ziplist</code> 编码：<br>1、保存的元素数量小于128；<br>2、保存的所有元素长度都小于64字节。</p>
<p>不能满足上面两个条件的使用 <code>skiplist</code> 编码。以上两个条件也可以通过Redis配置文件<code>zset-max-ziplist-entries</code> 选项和 <code>zset-max-ziplist-value</code> 进行修改。</p>
<p>假设我们要插入的结点是10，首先我们按照跳表查找结点的方法，找到待插入结点的前置结点（仅小于待插入结点）：</p>
<p><img src="/../../images/37c930c77206489399169c56786dd606.png" alt="img"></p>
<p>接下来，按照一般链表的插入方式，把结点10插入到结点9的下一个位置：</p>
<p><img src="/../../images/9637fdae9cf545e9b561454d5311b9c6.png" alt="img"></p>
<p>这样是不是插入工作就完成了呢？并不是。随着原始链表的新结点越来越多，索引会渐渐变得不够用了，因此索引结点也需要相应作出调整。</p>
<p>如何调整索引呢？我们让新插入的结点随机“晋升”，也就是成为索引结点。<strong>新结点晋升成功的几率是50%。</strong></p>
<p>假设第一次随机的结果是晋升成功，那么我们把结点10作为索引结点，插入到第1层索引的对应位置，并且向下指向原始链表的结点10：</p>
<p><img src="/../../images/7900200883c844b48f00beb22c4cb396.png" alt="img"></p>
<p>新结点在成功晋升之后，仍然有机会继续向上一层索引晋升。我们再进行一次随机，假设随机的结果是晋升失败，那么插入操作就告一段落了。</p>
<p>小灰说的是什么意思呢？让我们看看下图， 新结点10已经晋升到第2层索引，下一次随机的结果仍然是晋升成功，这时候该怎么办呢？</p>
<p><img src="/../../images/9eb747d7eb504e4aa3c8fffd09aa1e33.png" alt="img"></p>
<p><img src="/../../images/fdb807a921d44fb49a6e06909726090d.png" alt="img"></p>
<p><img src="/../../images/07bdf3513f104153a8dfda29d6f8e220.png" alt="img"></p>
<p>Redis之所以使用跳表而不使用红黑树原因如下：<br>    1.实现简单，相对于红黑树来说，<strong>实现更加的简单</strong>，不容易出错，代码更加容易维护和调试。<br>    2.跳表的<strong>底层节点</strong>有都是通过<strong>双向指针相互链接</strong>，这和B+树一样，对于范围查找会更加的方便。<br>    3.跳表的效率和红黑树一样，<strong>查找单个Key时间复杂度都是O(logn)</strong><br>    4.跳表更加灵活，可以通过改变索引构建策略，有效的平衡执行效率和内存消耗。</p>
<table>
<thead>
<tr>
<th>zrangebyscore<br />zrevrangebyscore</th>
<th>O(log(n)+k)，k为要获取成员个数，n为当前成员个数</th>
</tr>
</thead>
<tbody><tr>
<td>zadd</td>
<td>O(k*log(n))，k为添加 成员个数，n为当前成员个数</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="11、锁升级过程，轻量锁可以变成偏向锁么？偏向锁可以变成无锁么？对象头结构，锁状态变化过程？"><a href="#11、锁升级过程，轻量锁可以变成偏向锁么？偏向锁可以变成无锁么？对象头结构，锁状态变化过程？" class="headerlink" title="11、锁升级过程，轻量锁可以变成偏向锁么？偏向锁可以变成无锁么？对象头结构，锁状态变化过程？"></a>11、锁升级过程，轻量锁可以变成偏向锁么？偏向锁可以变成无锁么？对象头结构，锁状态变化过程？</h3><p><strong>锁可以升级但不能降级</strong>，意味着偏向锁升级成轻量级锁后不能降级成偏向锁。这种锁升级却不能降级的策略，目的是为了提高获得锁和释放锁的效率.</p>
<p>如果在运行过程中，遇到了其他线程抢占锁，则持有偏向锁的线程会被挂起，JVM会消除它身上的偏向锁，将锁恢复到标准的轻量级锁。偏向锁通过消除资源无竞争情况下的同步原语，进一步提高了程序的运行性能。一旦有第二个线程加入锁竞争，偏向锁就升级为轻量级锁（自旋锁）。升级为轻量级锁的时候需要撤销偏向锁，撤销偏向锁的时候会导致STW(stop the word)操作； </p>
<blockquote>
<p>锁竞争：如果多个线程轮流获取一个锁，但是每次获取锁的时候都很顺利，没有发生阻塞，那么就不存在锁竞争。只有当某线程尝试获取锁的时候，发现该锁已经被占用，只能等待其释放，这才发生了锁竞争。</p>
</blockquote>
<p><strong>轻量级锁（自旋锁）</strong></p>
<blockquote>
<p>自旋锁：自旋锁原理非常简单，如果持有锁的线程能在很短时间内释放锁资源，那么那些等待竞争锁的线程就不需要做内核态和用户态之间的切换进入阻塞挂起状态，它们只需要等一等（自旋），等持有锁的线程释放锁后即可立即获取锁，这样就避免用户线程和内核的切换的消耗。</p>
</blockquote>
<p>在轻量级锁状态下继续锁竞争，没有抢到锁的线程将自旋，即不停地循环判断锁是否能够被成功获取。长时间的自旋操作是非常消耗资源的，一个线程持有锁，其他线程就只能在原地空耗CPU，执行不了任何有效的任务，这种现象叫做忙等（busy-waiting）。如果锁竞争情况严重，某个达到最大自旋次数的线程，会将轻量级锁升级为重量级锁。</p>
<h3 id="12、Innodb的结构了解么？磁盘页和缓存区是怎么配合的？缓冲区和磁盘数据不一致怎么办，服务器突然宕机了数据会丢失么？"><a href="#12、Innodb的结构了解么？磁盘页和缓存区是怎么配合的？缓冲区和磁盘数据不一致怎么办，服务器突然宕机了数据会丢失么？" class="headerlink" title="12、Innodb的结构了解么？磁盘页和缓存区是怎么配合的？缓冲区和磁盘数据不一致怎么办，服务器突然宕机了数据会丢失么？"></a>12、Innodb的结构了解么？磁盘页和缓存区是怎么配合的？缓冲区和磁盘数据不一致怎么办，服务器突然宕机了数据会丢失么？</h3><p>MySQL底层架构，涉及到：</p>
<ul>
<li><strong>内存结构</strong>：<code>buffer pool</code>、<code>log buffer</code>、<code>change buffer</code>，buffer pool的页淘汰机制是怎样的；</li>
<li><strong>磁盘结构</strong>：<code>系统表空间</code>、<code>独立表空间</code>、<code>通用表空间</code>、<code>undo表空间</code>、<code>redo log</code>；</li>
<li>以及<code>IO</code>相关底层原理、查询<code>SQL执行流程</code>、数据<code>页结构</code>和<code>行结构</code>描述、<code>聚集索引</code>和<code>辅助索引</code>的底层数据组织方式、<code>MVCC</code>多版本并发控制的底层实现原理，以及可<code>重复读</code>、<code>读已提交</code>是怎么通过MVCC实现的。</li>
</ul>
<h3 id="13、InnoDB-索引为什使用B-树而不是用B树？"><a href="#13、InnoDB-索引为什使用B-树而不是用B树？" class="headerlink" title="13、InnoDB 索引为什使用B+树而不是用B树？"></a>13、InnoDB 索引为什使用B+树而不是用B树？</h3><p><strong>B+树只有叶节点存放数据，其余节点用来索引，而B-树是每个索引节点都会有Data域。</strong>所以从Mysql（Inoodb）的角度来看，B+树是用来充当索引的，一般来说索引非常大，尤其是关系性数据库这种数据量大的索引能达到亿级别，所以为了减少内存的占用，索引也会被存储在磁盘上。 </p>
<p><strong>那么Mysql如何衡量查询效率呢？– 磁盘IO次数。</strong> B-树&#x2F;B+树 的特点就是每层节点数目非常多，层数很少，目的就是为了就少磁盘IO次数，但是B-树的每个节点都有data域（指针），这无疑增大了节点大小，说白了增加了磁盘IO次数（磁盘IO一次读出的数据量大小是固定的，单个数据变大，每次读出的就少，IO次数增多，一次IO多耗时），而B+树除了叶子节点其它节点并不存储数据，节点小，磁盘IO次数就少。<strong>这是优点之一。</strong><br><strong>另一个优点是：</strong> B+树所有的Data域在叶子节点，一般来说都会进行一个优化，就是<strong>将所有的叶子节点用指针串起来</strong>。这样<strong>遍历</strong>叶子节点就能获得全部数据，这样就能进行区间访问啦。在数据库中基于范围的查询是非常频繁的，而B树不支持这样的遍历操作。</p>
<p>B树相对于红黑树的区别</p>
<p><strong>AVL 数和红黑树基本都是存储在内存中才会使用的数据结构</strong>。在大规模数据存储的时候，红黑树往往出现由于<strong>树的深度过大</strong>而造成磁盘IO读写过于频繁，进而导致效率低下的情况。为什么会出现这样的情况，我们知道要获取磁盘上数据，必须先通过磁盘移动臂移动到数据所在的柱面，然后找到指定盘面，接着旋转盘面找到数据所在的磁道，最后对数据进行读写。磁盘IO代价主要花费在查找所需的柱面上，树的深度过大会造成磁盘IO频繁读写。根据<strong>磁盘查找存取的次数往往由树的高度所决定</strong>，所以，只要我们通过某种较好的树结构减少树的结构尽量减少树的高度，B树可以有多个子女，从几十到上千，可以降低树的高度。</p>
<p><strong>数据库系统的设计者巧妙利用了磁盘预读原理</strong>，将一个节点的大小设为等于一个页，这样每个节点只需要一次I&#x2F;O就可以完全载入。为了达到这个目的，在实际实现B-Tree还需要使用如下技巧：每次新建节点时，直接申请一个页的空间，这样就保证<strong>一个节点物理上也存储在一个页里</strong>，加之计算机存储分配都是按页对齐的，就实现了一个node只需一次I&#x2F;O。</p>
<h3 id="14、MySQL-分表是怎么实现的？跨库join如何解决？数据量突增怎么解决？"><a href="#14、MySQL-分表是怎么实现的？跨库join如何解决？数据量突增怎么解决？" class="headerlink" title="14、MySQL 分表是怎么实现的？跨库join如何解决？数据量突增怎么解决？"></a>14、MySQL 分表是怎么实现的？跨库join如何解决？数据量突增怎么解决？</h3><h3 id="15、数据库的隔离级别，怎么实现的？当前读，快照读？MVCC？"><a href="#15、数据库的隔离级别，怎么实现的？当前读，快照读？MVCC？" class="headerlink" title="15、数据库的隔离级别，怎么实现的？当前读，快照读？MVCC？"></a>15、数据库的隔离级别，怎么实现的？当前读，快照读？MVCC？</h3><h3 id="16、mysql优化的实践经验"><a href="#16、mysql优化的实践经验" class="headerlink" title="16、mysql优化的实践经验"></a>16、mysql优化的实践经验</h3><h3 id="17、分布式事务出现过不一致吗？为什么？怎么解决？有什么方法避免？怎么监控？监控到怎么处理？什么时候需要人工接入？"><a href="#17、分布式事务出现过不一致吗？为什么？怎么解决？有什么方法避免？怎么监控？监控到怎么处理？什么时候需要人工接入？" class="headerlink" title="17、分布式事务出现过不一致吗？为什么？怎么解决？有什么方法避免？怎么监控？监控到怎么处理？什么时候需要人工接入？"></a>17、分布式事务出现过不一致吗？为什么？怎么解决？有什么方法避免？怎么监控？监控到怎么处理？什么时候需要人工接入？</h3><h3 id="18、io模型了解么？多路复用？selete，poll，epoll，epoll的结构？怎么注册事件？"><a href="#18、io模型了解么？多路复用？selete，poll，epoll，epoll的结构？怎么注册事件？" class="headerlink" title="18、io模型了解么？多路复用？selete，poll，epoll，epoll的结构？怎么注册事件？"></a>18、io模型了解么？多路复用？selete，poll，epoll，epoll的结构？怎么注册事件？</h3><h3 id="19、你们用的什么消息中间件，kafka，为什么用kafka？kafka是怎么保证高吞吐量的？"><a href="#19、你们用的什么消息中间件，kafka，为什么用kafka？kafka是怎么保证高吞吐量的？" class="headerlink" title="19、你们用的什么消息中间件，kafka，为什么用kafka？kafka是怎么保证高吞吐量的？"></a>19、你们用的什么消息中间件，kafka，为什么用kafka？kafka是怎么保证高吞吐量的？</h3><p><strong>kafka是怎么保证高吞吐量的</strong></p>
<p><strong>1.顺序读写</strong></p>
<p>kafka的消息是不断追加到文件中的，这个特性使kafka可以充分利用磁盘的顺序读写性能。顺序读写不需要硬盘磁头的寻道时间，只需很少的扇区旋转时间，所以速度远快于随机读写。<br>生产者负责写入数据，Kafka会将消息持久化到磁盘，保证不会丢失数据，Kafka采用了俩个技术提高写入的速度。<br><strong>1.顺序写入</strong>：如果是随机IO，磁盘会进行频繁的寻址，导致写入速度下降。Kafka使用了顺序IO提高了磁盘的写入速度，Kafka会将数据顺序插入到文件末尾，消费者端通过控制<strong>偏移量</strong>来读取消息，这样做会导致数据无法删除，时间一长，磁盘空间会满，kafka提供了2种策略来删除数据：基于时间删除和基于partition文件的大小删除。<br><strong>2.Memory Mapped Files</strong>：这个和Java NIO中的内存映射基本相同，在大学的计算机原理里我们学过（划重点），mmf直接利用操作系统的Page来实现文件到物理内存的映射，完成之后对物理内存的操作会直接同步到硬盘。mmf通过内存映射的方式大大提高了IO速率，省去了用户空间到内核空间的复制。它的缺点显而易见–不可靠，当发生宕机而数据未同步到硬盘时，数据会丢失，Kafka提供了produce.type参数来控制是否主动的进行刷新，如果kafka写入到mmp后立即flush再返回给生产者则为同步模式，反之为异步模式。</p>
<p><strong>2.零拷贝</strong></p>
<p>在这之前先来了解一下零拷贝(直接让操作系统的 Cache 中的数据发送到网卡后传输给下游的消费者)：平时从服务器读取静态文件时，服务器先将文件从复制到内核空间，再复制到用户空间，最后再复制到内核空间并通过网卡发送出去，而零拷贝则是直接从内核到内核再到网卡，省去了用户空间的复制。<br>Kafka把所有的消息存放到一个文件中，当消费者需要数据的时候直接将文件发送给消费者，比如10W的消息共10M，全部发送给消费者，10M的消息在内网中传输是非常快的，假如需要1s，那么kafka的tps就是10w。Zero copy对应的是Linux中sendfile函数，这个函数会接受一个offsize来确定从哪里开始读取。现实中，不可能将整个文件全部发给消费者，他通过消费者传递过来的偏移量来使用零拷贝读取指定内容的数据返回给消费者。</p>
<p>在Linux kernel2.2 之后出现了一种叫做”零拷贝(zero-copy)”系统调用机制，就是跳过“用户缓冲区”的拷贝，建立一个磁盘空间和内存的直接映射，数据不再复制到“用户态缓冲区”，系统上下文切换减少为2次，可以提升一倍的性能。</p>
<p><img src="/../../images/webp" alt="img"></p>
<p><strong>3.分区</strong></p>
<p>kafka中的topic中的内容可以被分为多分partition存在,每个partition又分为多个段segment,所以每次操作都是针对一小部分做操作，很轻便，并且增加<code>并行操作</code>的能力</p>
<p><strong>4.批量发送</strong></p>
<p>kafka允许进行批量发送消息，producter发送消息的时候，可以将消息缓存在本地,等到了固定条件发送到kafka</p>
<ol>
<li>等消息条数到固定条数</li>
<li>一段时间发送一次</li>
</ol>
<p><strong>5.数据压缩</strong></p>
<p>Kafka还支持对消息集合进行压缩，Producer可以通过GZIP或Snappy格式对消息集合进行压缩。<br>压缩的好处就是减少传输的数据量，减轻对网络传输的压力。</p>
<p>Producer压缩之后，在Consumer需进行解压，虽然增加了CPU的工作，但在对大数据处理上，瓶颈在网络上而不是CPU，所以这个成本很值得*<code>批量发送</code>和<code>数据压缩</code>一起使用,单条做数据压缩的话，效果不明显*</p>
<p>Kafka的设计目标是高吞吐量，它比其它消息系统快的原因体现在以下几方面：</p>
<p>1、Kafka操作的是序列文件I &#x2F; O（序列文件的特征是按顺序写，按顺序读），为保证顺序，Kafka强制点对点的按顺序传递消息，这意味着，一个consumer在消息流（或分区）中只有一个位置。</p>
<p>2、Kafka不保存消息的状态，即消息是否被“消费”。一般的消息系统需要保存消息的状态，并且还需要以随机访问的形式更新消息的状态。而Kafka 的做法是保存Consumer在Topic分区中的位置offset，在offset之前的消息是已被“消费”的，在offset之后则为未“消费”的，并且offset是可以任意移动的，这样就消除了大部分的随机IO。</p>
<p>3、Kafka支持点对点的批量消息传递。</p>
<p>4、Kafka的消息存储在OS pagecache（页缓存，page cache的大小为一页，通常为4K，在Linux读写文件时，它用于缓存文件的逻辑内容，从而加快对磁盘上映像和数据的访问）。</p>
<h3 id="20、kafka重平衡，重启服务怎么保证kafka不发生重平衡，有什么方案？"><a href="#20、kafka重平衡，重启服务怎么保证kafka不发生重平衡，有什么方案？" class="headerlink" title="20、kafka重平衡，重启服务怎么保证kafka不发生重平衡，有什么方案？"></a>20、kafka重平衡，重启服务怎么保证kafka不发生重平衡，有什么方案？</h3><h3 id="21、netty的原理和使用？tcp的连接过程？一台服务器能支持多少连接，为什么-？tcp各个参数怎么设置？"><a href="#21、netty的原理和使用？tcp的连接过程？一台服务器能支持多少连接，为什么-？tcp各个参数怎么设置？" class="headerlink" title="21、netty的原理和使用？tcp的连接过程？一台服务器能支持多少连接，为什么 ？tcp各个参数怎么设置？"></a>21、netty的原理和使用？tcp的连接过程？一台服务器能支持多少连接，为什么 ？tcp各个参数怎么设置？</h3><p><strong>服务端</strong></p>
<p>我们现在在来回头考虑服务器端。对于服务器来说，最大支持的并发连接是多少呢？就有人开始可爱地糊涂了：“服务器端理论也是端口限制吗？”。好，假设如果受影响的话，那我们的Nginx服务器只监听了一个80端口。那Nginx只能接受一个TCP连接喽？这明显是太荒唐了。</p>
<p>好，我们再看另外一个靠谱一点的答案。那就是一条TCP连接是由一个四元组组成的。不考虑地址重用（unix的SO_REUSEADDR选项）的情况下，对于我们这台Nginx Server来说，它的IP和端口是固定的。cp连接4元组中只有remote ip（也就是client ip）和remote port（客户端port）是可变的。它可能建立的最大的连接数是2的32次方（ip数）×2的16次方（port数）。这是2.8*10的14次方的一个大数字，两百万亿！！</p>
<p>Linux上除了监听80以外，还可以监听其它的端口，例如Mysql的3306, Redis的6339，当然所有65535个端口你都可以用来监听一遍。这样理论上线就到了2的32次方（ip数）×2的16次方（port数）×2的16次方（服务器port数）个。感兴趣你可以算一下，这个基本相当于无穷个了。</p>
<p>不过理想和实际总是会有差距的，因为Linux每维护一条TCP连接都要花费资源。处理连接请求，保活，数据的收发时需要消耗一些CPU，维持TCP连接主要消耗内存。我们题目的问题是考虑最大多少个连接，所以我们先不考虑数据的收发。那么TCP在静止的状态下，就不怎么消耗CPU了，主要消耗内存。而Linux上内存是有限的。<br>我们今天先直接把结论抛出来，一条TCP连接如果不发送数据的话，消耗内存是3.3K左右。如果有数据发送，需要为每条TCP分配发送缓存区，大小受你的参数net.ipv4.tcp_wmem配置影响，默认情况下最小是4K。如果发送结束，缓存区消耗的内存会被回收详细的分析过程敬请期待接下来的另一篇文章。</p>
<p><strong>假设你只保持连接不发送数据，那么你服务器可以建立的连接最大数量 &#x3D; 你的内存&#x2F;3.3K。</strong> 假如是4GB的内存，那么大约可接受的TCP连接数量是100万左右。</p>
<blockquote>
<p>这个例子里，我们考虑的前提是在一个进程下hold所有的服务器端连接。而在实际中的项目里，为了收发数据方便，很多网络IO模型还会为TCP连接再创建一个线程或协程。拿最轻量的golang来说，一个协程栈也需要2KB的内存开销。</p>
</blockquote>
<p><strong>结论</strong></p>
<p>一台机器最大究竟能支持多少个网络连接？这个简单的问题里其实埋了坑，导致无数的英雄好汉被困惑不解。就和树上九只鸟打死一只还剩几只的问题一样，没有和你说清楚树上是真鸟，还是假鸟。也没有说枪是有声还是无声的。通过今天的分析，相信你终于可以扬眉吐气把这个问题踩在脚下摩擦了。来，总结下：</p>
<ul>
<li><strong>TCP连接的客户端机：</strong>每一个ip可建立的TCP连接理论受限于内核net.ip_local_port_range参数，也受限于65535。但可以通过配置多ip的方式来加大自己的建立连接的能力。</li>
<li><strong>TCP连接的服务器机：</strong>每一个监听的端口虽然理论值很大，但这个数字没有实际意义。最大并发数取决你的内存大小，每一条静止状态的TCP连接大约需要吃3.3K的内存。</li>
</ul>
<h3 id="22、Sping的AOP实现原理，以及对象生成方式的种类，单例的还是原型的？"><a href="#22、Sping的AOP实现原理，以及对象生成方式的种类，单例的还是原型的？" class="headerlink" title="22、Sping的AOP实现原理，以及对象生成方式的种类，单例的还是原型的？"></a>22、Sping的AOP实现原理，以及对象生成方式的种类，单例的还是原型的？</h3><h3 id="23、讲讲调度接口是怎么实现的"><a href="#23、讲讲调度接口是怎么实现的" class="headerlink" title="23、讲讲调度接口是怎么实现的"></a>23、讲讲调度接口是怎么实现的</h3><p>Timer 的设计核心是一个 TaskQueue 和一个 TimerThread。Timer 将接收到的任务丢到自己的 TaskQueue中。TimerThread 在创建 Timer 时会启动成为一个守护线程。这个线程会轮询所有任务，找到一个最近要执行的任务，然后休眠，当到达最近要执行任务的开始时间点，TimerThread 被唤醒并执行该任务。之后 TimerThread 更新最近一个要执行的任务，继续休眠。</p>
<h3 id="24、分布式唯一ID是怎么实现的"><a href="#24、分布式唯一ID是怎么实现的" class="headerlink" title="24、分布式唯一ID是怎么实现的"></a>24、分布式唯一ID是怎么实现的</h3><h3 id="25、设计模式，以及自己使用的场景"><a href="#25、设计模式，以及自己使用的场景" class="headerlink" title="25、设计模式，以及自己使用的场景"></a>25、设计模式，以及自己使用的场景</h3><h3 id="26、有没有用过分布式锁，怎么实现的，讲讲原理"><a href="#26、有没有用过分布式锁，怎么实现的，讲讲原理" class="headerlink" title="26、有没有用过分布式锁，怎么实现的，讲讲原理"></a>26、有没有用过分布式锁，怎么实现的，讲讲原理</h3><h3 id="27、如何解决线上问题？cpu狂飙怎么办？频繁minor-gc怎么办？可能造成的原因是什么？如何避免？"><a href="#27、如何解决线上问题？cpu狂飙怎么办？频繁minor-gc怎么办？可能造成的原因是什么？如何避免？" class="headerlink" title="27、如何解决线上问题？cpu狂飙怎么办？频繁minor gc怎么办？可能造成的原因是什么？如何避免？"></a>27、如何解决线上问题？cpu狂飙怎么办？频繁minor gc怎么办？可能造成的原因是什么？如何避免？</h3><h3 id="28、怎么理解分布式和微服务，为什么要拆分服务，会产生什么问题，怎么解决这些问题-？"><a href="#28、怎么理解分布式和微服务，为什么要拆分服务，会产生什么问题，怎么解决这些问题-？" class="headerlink" title="28、怎么理解分布式和微服务，为什么要拆分服务，会产生什么问题，怎么解决这些问题 ？"></a>28、怎么理解分布式和微服务，为什么要拆分服务，会产生什么问题，怎么解决这些问题 ？</h3><p><strong>面试题剖析</strong></p>
<p><strong>为什么要将系统进行拆分？</strong></p>
<p>网上查查，答案极度零散和复杂，很琐碎，原因一大坨。但是我这里给大家直观的感受：</p>
<p>1.代码量大，容易冲突，合并非常耗费时间<br>2.不敢随意乱改技术。</p>
<p><strong>拆分了以后</strong>，每个人维护自己的服务就可以了。技术上想怎么升级就怎么升级，大幅度提升复杂系统大型团队的开发效率</p>
<p><strong>拆分后不用 dubbo 可以吗？</strong></p>
<p>当然可以了，大不了最次，就是各个系统之间，直接基于 spring mvc，就纯 http 接口互相通信呗，还能咋样。但是这个肯定是有问题的，因为 http 接口通信维护起来成本很高，你要考虑<strong>超时重试</strong>、<strong>负载均衡</strong>等等各种乱七八糟的问题，比如说你的订单系统调用商品系统，商品系统部署了 5 台机器，你怎么把请求均匀地甩给那 5 台机器？这不就是负载均衡？你要是都自己搞那是可以的，但是确实很痛苦。</p>
<p>所以 dubbo 说白了，是一种 rpc 框架，就是说本地就是进行接口调用，但是 dubbo 会代理这个调用请求，跟远程机器网络通信，给你处理掉负载均衡了、服务实例上下线自动感知了、超时重试了，等等乱七八糟的问题。那你就不用自己做了，用 dubbo 就可以了。</p>
<h3 id="29、怎么理解高可用，如何保证高可用，有什么弊端，熔断机制，怎么实现-？"><a href="#29、怎么理解高可用，如何保证高可用，有什么弊端，熔断机制，怎么实现-？" class="headerlink" title="29、怎么理解高可用，如何保证高可用，有什么弊端，熔断机制，怎么实现 ？"></a>29、怎么理解高可用，如何保证高可用，有什么弊端，熔断机制，怎么实现 ？</h3><h3 id="30、对于高并发怎么看，怎么算高并发，你们项目有么，如果有会产生什么问题，怎么解决"><a href="#30、对于高并发怎么看，怎么算高并发，你们项目有么，如果有会产生什么问题，怎么解决" class="headerlink" title="30、对于高并发怎么看，怎么算高并发，你们项目有么，如果有会产生什么问题，怎么解决"></a>30、对于高并发怎么看，怎么算高并发，你们项目有么，如果有会产生什么问题，怎么解决</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>31、有没有做过压测的项目？首页接口优化是怎么做的？<br>32、如何优雅的写代码？什么代码算做优雅？什么代码是规范？你们代码规范是什么样的？如何进行code review？<br>33、算法：给定一个长度为N的整形数组arr，其中有N个互不相等的自然数1-N，请实现arr的排序，但是不要把下标0∼N−1位置上的数通过直接赋值的方式替换成1∼N<br>34、算法：判断一个树是否是平衡二叉树<br>35、算法：给定一个二叉树，请计算节点值之和最大的路径的节点值之和是多少，这个路径的开始节点和结束节点可以是二叉树中的任意节点<br>36、算法：LRU 缓存<br>37、算法：实现带有getMin功能的栈，要求push，pop，getMin的时间复杂度都是O(1)<br>38、算法：两数之和<br>39、算法：实现二叉树先序，中序和后序遍历</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-23T09:02:41.000Z" title="2021/7/23 下午5:02:41">2021-07-23</time>发表</span><span class="level-item"><time dateTime="2021-07-23T09:02:41.000Z" title="2021/7/23 下午5:02:41">2021-07-23</time>更新</span><span class="level-item">11 分钟读完 (大约1697个字)</span></div></div><div class="content"><h3 id="线程安全的机制"><a href="#线程安全的机制" class="headerlink" title="线程安全的机制"></a>线程安全的机制</h3><p>线程表示一条单独的执行流，每个线程都有自己的执行计数器，有自己的栈，但可以共享内存。共享内存有2个问题：竞态条件、内存可见性</p>
<p>1.synchronized<br>2.使用显式锁<br>3.使用volatile<br>4.使用原子变量和CAS<br>5.写时复制<br>6.ThreadLocal</p>
<p>显式锁是相对synchronized隐式锁而言的，需要自己创建锁，主要实现类ReentrantLock。相比synchronized，显示锁支持以非阻塞方式获取锁，可以响应中断、限时、指定公平性、解决死锁问题。<br>在读多写少、读并发情景中，可以通过读写锁提高并发度，读写锁接口ReadWriteLock</p>
<p>volatile。保证安全不一定需要锁，共享对象只有一个，操作也只是进行最简单的get、set操作，就不存在竞态条件问题，只有内存可见性问题。这时在变量声明上加上volatile就可以了。</p>
<p>写时复制<br>之所以会有线程安全的问题，是因为多个线程并发读写同一个对象，如果每个线程读写的对象都是不同的，或者，如果共享访问的对象是只读的，不能修改，那也就不存在线程安全问题了。<br>我们在介绍容器类CopyOnWriteArrayList和CopyOnWriteArraySet时介绍了写时复制技术，写时复制就是将共享访问的对象变为只读的，写的时候，再使用锁，保证只有一个线程写，写的线程不是直接修改原对象，而是新创建一个对象，对该对象修改完毕后，再原子性地修改共享访问的变量，让它指向新的对象。</p>
<h3 id="20-2线程的协作机制"><a href="#20-2线程的协作机制" class="headerlink" title="20.2线程的协作机制"></a>20.2线程的协作机制</h3><p>wail&#x2F;notify<br>显示条件<br>线程的中断<br>协作工具类<br>阻塞队列<br>Future&#x2F;FutureTask</p>
<h3 id="23-1-静态代理"><a href="#23-1-静态代理" class="headerlink" title="23.1 静态代理"></a>23.1 静态代理</h3><h3 id="23-2-JAVA-SDK动态代理"><a href="#23-2-JAVA-SDK动态代理" class="headerlink" title="23.2 JAVA SDK动态代理"></a>23.2 JAVA SDK动态代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleJDKDynamicProxyDemo</span> &#123;￼</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">IService</span> &#123;￼</span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span>;￼</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RealService</span> <span class="keyword">implements</span> <span class="title class_">IService</span> &#123;￼</span><br><span class="line">  	<span class="meta">@Override</span>￼</span><br><span class="line">	  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;￼</span><br><span class="line">    	System.out.println(<span class="string">&quot;hello&quot;</span>);￼      </span><br><span class="line">    &#125;￼</span><br><span class="line"> 	&#125;￼</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SimpleInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;￼                </span><br><span class="line">      <span class="keyword">private</span> Object realObj;￼</span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">SimpleInvocationHandler</span><span class="params">(Object realObj)</span> &#123;￼</span><br><span class="line">        <span class="built_in">this</span>.realObj = realObj;￼</span><br><span class="line">      &#125;￼</span><br><span class="line">      <span class="meta">@Override</span>￼</span><br><span class="line">      <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;￼</span><br><span class="line">          System.out.println(<span class="string">&quot;entering &quot;</span> + method.getName());￼</span><br><span class="line">	    		<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(realObj, args);￼        </span><br><span class="line">          System.out.println(<span class="string">&quot;leaving &quot;</span> + method.getName());￼</span><br><span class="line">          <span class="keyword">return</span> result;￼</span><br><span class="line">      &#125;￼</span><br><span class="line">  &#125;￼</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">IService</span> <span class="variable">realService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealService</span>();￼</span><br><span class="line">    <span class="type">IService</span> <span class="variable">proxyService</span> <span class="operator">=</span> (IService) Proxy.newProxyInstance(￼IService.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;? &gt;[] &#123; IService.class &#125;,￼ <span class="keyword">new</span> <span class="title class_">SimpleInvocationHandler</span>(realService));￼</span><br><span class="line">    proxyService.sayHello();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="23-3-cglib动态代理"><a href="#23-3-cglib动态代理" class="headerlink" title="23.3 cglib动态代理"></a>23.3 cglib动态代理</h3><p>Java SDK动态代理的局限在于，它只能为接口创建代理，返回的代理对象也只能转换到某个接口类型，如果一个类没有接口，或者希望代理非接口中定义的方法，那就没有办法了。有一个第三方的类库cglib（<a target="_blank" rel="noopener" href="https://github.com/cglib/cglib%EF%BC%89%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%81%9A%E5%88%B0%E8%BF%99%E4%B8%80%E7%82%B9%EF%BC%8CSpring%E3%80%81Hibernate%E7%AD%89%E9%83%BD%E4%BD%BF%E7%94%A8%E8%AF%A5%E7%B1%BB%E5%BA%93%E3%80%82%E6%88%91%E4%BB%AC%E7%9C%8B%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%8C%E5%A6%82%E4%BB%A3%E7%A0%81%E6%B8%85%E5%8D%9523-5%E6%89%80%E7%A4%BA%E3%80%82">https://github.com/cglib/cglib），可以做到这一点，Spring、Hibernate等都使用该类库。我们看个简单的例子，如代码清单23-5所示。</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCGLibDemo</span> &#123;￼            </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RealService</span> &#123;￼             </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;￼</span><br><span class="line">    	System.out.println(<span class="string">&quot;hello&quot;</span>);￼</span><br><span class="line">    &#125;￼</span><br><span class="line">  &#125;￼</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SimpleInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;￼</span><br><span class="line">    <span class="meta">@Override</span>￼</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object object, Method method,￼ Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    ￼  System.out.println(<span class="string">&quot;entering &quot;</span> + method.getName());￼</span><br><span class="line">      <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proxy.invokeSuper(object, args);￼</span><br><span class="line">      System.out.println(<span class="string">&quot;leaving &quot;</span> + method.getName());￼</span><br><span class="line">      <span class="keyword">return</span> result;￼</span><br><span class="line">    &#125;￼</span><br><span class="line">  &#125;￼</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class&lt;T&gt; cls)</span> &#123;￼</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();￼</span><br><span class="line">    enhancer.setSuperclass(cls);￼</span><br><span class="line">    enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">SimpleInterceptor</span>());￼</span><br><span class="line">    <span class="keyword">return</span> (T) enhancer.create();￼</span><br><span class="line">  &#125;￼         </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;￼                		  </span><br><span class="line">    <span class="type">RealService</span> <span class="variable">proxyService</span> <span class="operator">=</span> getProxy(RealService.class);￼</span><br><span class="line">    proxyService.sayHello();￼</span><br><span class="line">  &#125;￼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RealService表示被代理的类，它没有接口。getProxy()为一个类生成代理对象，这个代理对象可以安全地转换为被代理类的类型，它使用了cglib的Enhancer类。Enhancer类的setSuperclass设置被代理的类，setCallback设置被代理类的public非final方法被调用时的处理类。Enhancer支持多种类型，这里使用的类实现了MethodInterceptor接口，它与Java SDK中的InvocationHandler有点类似，方法名称变成了intercept，多了一个MethodProxy类型的参数。<br>与前面的InvocationHandler不同，SimpleInterceptor中没有被代理的对象，它通过MethodProxy的invokeSuper方法调用被代理类的方法：<br>￼   <code>Object result = proxy.invokeSuper(object, args);</code><br>注意，它不能这样调用被代理类的方法：<br>￼   <code>Object result = method.invoke(object, args);</code></p>
<p>object是代理对象，调用这个方法还会调用到SimpleInterceptor的intercept方法，造成死循环。<br>在main方法中，我们也没有创建被代理的对象，创建的对象直接就是代理对象。<br>cglib的实现机制与Java SDK不同，它是通过继承实现的，它也是动态创建了一个类，但这个类的父类是被代理的类，代理类重写了父类的所有public非final方法，改为调用Callback中的相关方法，在上例中，调用SimpleInterceptor的intercept方法。</p>
<h3 id="23-4-Java-SDK代理与cglib代理比较"><a href="#23-4-Java-SDK代理与cglib代理比较" class="headerlink" title="23.4 Java SDK代理与cglib代理比较"></a>23.4 Java SDK代理与cglib代理比较</h3><p>Java SDK代理面向的是一组接口，它为这些接口动态创建了一个实现类。接口的具体实现逻辑是通过自定义的InvocationHandler实现的，这个实现是自定义的，也就是说，其背后都不一定有真正被代理的对象，也可能有多个实际对象，根据情况动态选择。cglib代理面向的是一个具体的类，它动态创建了一个新类，继承了该类，重写了其方法。<br>从代理的角度看，Java SDK代理的是对象，需要先有一个实际对象，自定义的InvocationHandler引用该对象，然后创建一个代理类和代理对象，客户端访问的是代理对象，代理对象最后再调用实际对象的方法；cglib代理的是类，创建的对象只有一个。<br>如果目的都是为一个类的方法增强功能，Java SDK要求该类必须有接口，且只能处理接口中的方法，cglib没有这个限制。</p>
<h3 id="12-1-抽象容器类"><a href="#12-1-抽象容器类" class="headerlink" title="12.1 抽象容器类"></a>12.1 抽象容器类</h3><p>抽象容器类与之前介绍的接口和具体容器类的关系如图12-1所示。<br>虚线框表示接口，有Collection、List、Set、Queue、Deque和Map。有6个抽象容器类。<br>1）AbstractCollection：实现了Collection接口，被抽象类AbstractList、AbstractSet、AbstractQueue继承，ArrayDeque也继承自AbstractCollection（图中未画出）。<br>2）AbstractList：父类是AbstractCollection，实现了List接口，被ArrayList、Abstract-SequentialList继承。</p>
<p><img src="/../images/575A5B45-0F35-41F5-85F5-7B2188030FF9.png" alt="575A5B45-0F35-41F5-85F5-7B2188030FF9"></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90002%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3TCP%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/"><img class="fill" src="/../../images/cover2.jpg" alt="90002 快速了解TCP的流量控制与拥塞控制"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-14T07:55:12.000Z" title="2021/7/14 下午3:55:12">2021-07-14</time>发表</span><span class="level-item"><time dateTime="2022-05-08T11:54:23.985Z" title="2022/5/8 下午7:54:23">2022-05-08</time>更新</span><span class="level-item">19 分钟读完 (大约2899个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90002%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3TCP%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/">90002 快速了解TCP的流量控制与拥塞控制</a></h1><div class="content"><h1 id="快速了解TCP的流量控制与拥塞控制"><a href="#快速了解TCP的流量控制与拥塞控制" class="headerlink" title="快速了解TCP的流量控制与拥塞控制"></a>快速了解TCP的流量控制与拥塞控制</h1><p>有关TCP你不能不知道的三次握手和四次挥手问题，<a target="_blank" rel="noopener" href="https://www.toutiao.com/i6711623920568500743/?group_id=6711623920568500743">关于三次握手与四次挥手你要知道这些</a></p></div><a class="article-more button is-small is-size-7" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90002%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3TCP%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90006TCP%E7%B2%98%E6%8B%86%E5%8C%85%E8%AF%A6%E8%A7%A3%E4%B8%8ENetty%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/"><img class="fill" src="/../../images/bb8b60d1c9ae493dbe3557c0017ffa15.png" alt="90006 TCP粘拆包详解与Netty代码示例"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-14T07:54:46.000Z" title="2021/7/14 下午3:54:46">2021-07-14</time>发表</span><span class="level-item"><time dateTime="2022-05-08T12:43:13.935Z" title="2022/5/8 下午8:43:13">2022-05-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></span><span class="level-item">11 分钟读完 (大约1583个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90006TCP%E7%B2%98%E6%8B%86%E5%8C%85%E8%AF%A6%E8%A7%A3%E4%B8%8ENetty%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/">90006 TCP粘拆包详解与Netty代码示例</a></h1><div class="content"><h1 id="TCP粘拆包详解与Netty代码示例"><a href="#TCP粘拆包详解与Netty代码示例" class="headerlink" title="TCP粘拆包详解与Netty代码示例"></a>TCP粘拆包详解与Netty代码示例</h1><p>TCP是个“流”协议，所谓流，就是没有界限的一串数据。可以想想河里的流水，是连成一片的，其间并没有分界线。TCP底层并不了解上层业务数据的具体含义，它会根据TCP缓冲区的实际情况进行包的划分，所以在业务上认为，一个完整的包可能会被TCP拆分成多个包进行发送，也有可能把多个小的包封装成一个大的数据包发送，这就是所谓的TCP粘包和拆包问题。</p>
<blockquote>
<p>有关TCP的详细讲解，可以点击<a target="_blank" rel="noopener" href="https://www.toutiao.com/i6711623920568500743/?group_id=6711623920568500743">关于三次握手与四次挥手你要知道这些</a>和<a target="_blank" rel="noopener" href="https://www.toutiao.com/i6711818943989809671/?group_id=6711818943989809671">快速了解TCP的流量控制与拥塞控制</a></p>
</blockquote></div><a class="article-more button is-small is-size-7" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90006TCP%E7%B2%98%E6%8B%86%E5%8C%85%E8%AF%A6%E8%A7%A3%E4%B8%8ENetty%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90003%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82NIO%E6%95%88%E7%8E%87%E9%AB%98%E7%9A%84%E5%8E%9F%E7%90%86/"><img class="fill" src="/../../images/cover3.jpg" alt="90003彻底搞懂NIO效率高的原理"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-14T07:53:00.000Z" title="2021/7/14 下午3:53:00">2021-07-14</time>发表</span><span class="level-item"><time dateTime="2022-05-08T11:54:26.799Z" title="2022/5/8 下午7:54:26">2022-05-08</time>更新</span><span class="level-item">18 分钟读完 (大约2746个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90003%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82NIO%E6%95%88%E7%8E%87%E9%AB%98%E7%9A%84%E5%8E%9F%E7%90%86/">90003彻底搞懂NIO效率高的原理</a></h1><div class="content"><h1 id="彻底搞懂NIO效率高的原理"><a href="#彻底搞懂NIO效率高的原理" class="headerlink" title="彻底搞懂NIO效率高的原理"></a>彻底搞懂NIO效率高的原理</h1><p><strong>前言</strong></p>
<p>这篇文章读不懂的没关系，可以先收藏一下。笔者准备介绍完epoll和NIO等知识点，然后写一篇Java网络IO模型的介绍，这样可以使Java网络IO的知识体系更加地完整和严谨。初学者也可以等看完IO模型介绍的博客之后，再回头看这些博客，会更加有收获。</p></div><a class="article-more button is-small is-size-7" href="/2021/07/14/90000%E6%96%87%E7%AB%A0/90003%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82NIO%E6%95%88%E7%8E%87%E9%AB%98%E7%9A%84%E5%8E%9F%E7%90%86/#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-14T02:50:33.000Z" title="2021/7/14 上午10:50:33">2021-07-14</time>发表</span><span class="level-item"><time dateTime="2021-07-14T02:50:33.000Z" title="2021/7/14 上午10:50:33">2021-07-14</time>更新</span><span class="level-item">5 分钟读完 (大约796个字)</span></div></div><div class="content"><h2 id="服务端如何防止重复支付"><a href="#服务端如何防止重复支付" class="headerlink" title="服务端如何防止重复支付"></a>服务端如何防止重复支付</h2><p><img src="/../../images/image-20210714103550351.png" alt="image-20210714103550351"></p>
<p>如图是一个简化的下单流程，首先是提交订单，然后是支付。支付的话，一般是走支付网关（支付中心），然后支付中心与第三方支付渠道（微信、支付宝、银联）交互，支付成功以后，异步通知支付中心，支付中心更新自身支付订单状态，再通知业务应用，各业务再更新各自订单状态。</p>
<p>这个过程中经常可能遇到的问题是掉单，无论是超时未收到回调通知也好，还是程序自身报错也好，总之由于各种各样的原因，没有如期收到通知并正确的处理后续逻辑等等，都会造成用户支付成功了，但是服务端这边订单状态没更新，这个时候有可能产生投诉，或者用户重复支付。</p>
<p>由于③⑤造成的掉单称之为外部掉单，由④⑥造成的掉单我们称之为内部掉单</p>
<p>为了防止掉单，这里可以这样处理：</p>
<p>1、支付订单增加一个中间状态“支付中”，当同一个订单去支付的时候，先检查有没有状态为“支付中”的支付流水，当然支付（prepay）的时候要加个锁。支付完成以后更新支付流水状态的时候再讲其改成“支付成功”状态。</p>
<p>2、支付中心这边要自己定义一个超时时间（比如：30秒），在此时间范围内如果没有收到支付成功回调，则应调用接口主动查询支付结果，比如10s、20s、30s查一次，如果在最大查询次数内没有查到结果，应做异常处理</p>
<p>3、支付中心收到支付结果以后，将结果同步给业务系统，可以发MQ，也可以直接调用，直接调用的话要加重试（比如：SpringBoot Retry）</p>
<p>4、无论是支付中心，还是业务应用，在接收支付结果通知时都要考虑接口幂等性，消息只处理一次，其余的忽略</p>
<p>5、业务应用也应做超时主动查询支付结果</p>
<p>对于上面说的超时主动查询可以在发起支付的时候将这些支付订单放到一张表中，用定时任务去扫</p>
<p>为了防止订单重复提交，可以这样处理：</p>
<p>1、创建订单的时候，用订单信息计算一个哈希值，判断redis中是否有key，有则不允许重复提交，没有则生成一个新key，放到redis中设置个过期时间，然后创建订单。其实就是在一段时间内不可重复相同的操作</p>
<p>附上微信支付最佳实践：</p>
<p><img src="/../../images/image-20210714103728658.png" alt="image-20210714103728658"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-02T10:38:58.000Z" title="2021/7/2 下午6:38:58">2021-07-02</time>发表</span><span class="level-item"><time dateTime="2021-07-02T10:38:58.000Z" title="2021/7/2 下午6:38:58">2021-07-02</time>更新</span><span class="level-item">12 分钟读完 (大约1808个字)</span></div></div><div class="content"><p>[toc]</p>
<h1 id="「DUBBO系列」责任链模式实现原理与源码分析"><a href="#「DUBBO系列」责任链模式实现原理与源码分析" class="headerlink" title="「DUBBO系列」责任链模式实现原理与源码分析"></a>「DUBBO系列」责任链模式实现原理与源码分析</h1><h2 id="1-文章概述"><a href="#1-文章概述" class="headerlink" title="1 文章概述"></a>1 文章概述</h2><p>责任链模式将请求发送和接收解耦，让多个接收对象都有机会处理这个请求。这些接收对象串成一条链路并沿着这条链路传递这个请求，直到链路上某个接收对象能够处理它。本文我们介绍责任链模式两种应用场景和四种代码实现方式，最后介绍了DUBBO如何应用责任链构建过滤器链路。</p>
<h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a>2 应用场景</h2><h3 id="2-1-命中立即中断"><a href="#2-1-命中立即中断" class="headerlink" title="2.1 命中立即中断"></a>2.1 命中立即中断</h3><p>我们实现一个关键词过滤功能。系统设置三个关键词过滤器，输入内容命中任何一个过滤器规则就返回校验不通过，链路立即中断无需继续进行。</p>
<h4 id="1-实现方式一"><a href="#1-实现方式一" class="headerlink" title="(1) 实现方式一"></a>(1) 实现方式一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContentFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AaaContentFilter</span> <span class="keyword">implements</span> <span class="title class_">ContentFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">KEY_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> isValid;</span><br><span class="line">        &#125;</span><br><span class="line">        isValid = !content.contains(KEY_CONTENT);</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BbbContentFilter</span> <span class="keyword">implements</span> <span class="title class_">ContentFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">KEY_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;bbb&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> isValid;</span><br><span class="line">        &#125;</span><br><span class="line">        isValid = !content.contains(KEY_CONTENT);</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CccContentFilter</span> <span class="keyword">implements</span> <span class="title class_">ContentFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">KEY_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;ccc&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> isValid;</span><br><span class="line">        &#125;</span><br><span class="line">        isValid = !content.contains(KEY_CONTENT);</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体过滤器已经编写完成，接下来构造过滤器责任链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterHandlerChain</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">FilterHandler</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">FilterHandler</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FilterHandler</span> <span class="variable">aaaHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AaaContentFilter</span>();</span><br><span class="line">        <span class="type">FilterHandler</span> <span class="variable">bbbHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BbbContentFilter</span>();</span><br><span class="line">        addHandler(aaaHandler);</span><br><span class="line">        addHandler(bbbHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHandler</span><span class="params">(FilterHandler handler)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            head = tail = handler;</span><br><span class="line">            head.setSuccessor(tail);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 设置当前tail继任者 **/</span></span><br><span class="line">        tail.setSuccessor(handler);</span><br><span class="line">        <span class="comment">/** 指针重新指向tail **/</span></span><br><span class="line">        tail = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == head) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;FilterHandlerChain is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** head发起调用 **/</span></span><br><span class="line">        <span class="keyword">return</span> head.filter(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;classpath*:META-INF/chain/spring-core.xml&quot;</span> &#125;);</span><br><span class="line">        <span class="type">FilterHandlerChain</span> <span class="variable">chain</span> <span class="operator">=</span> (FilterHandlerChain) context.getBean(<span class="string">&quot;filterHandlerChain&quot;</span>);</span><br><span class="line">        System.out.println(context);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result1</span> <span class="operator">=</span> chain.filter(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result2</span> <span class="operator">=</span> chain.filter(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;校验结果1=&quot;</span> + result1);</span><br><span class="line">        System.out.println(<span class="string">&quot;校验结果2=&quot;</span> + result2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-实现方式二"><a href="#2-实现方式二" class="headerlink" title="(2) 实现方式二"></a>(2) 实现方式二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FilterHandler</span> &#123;</span><br><span class="line"><span class="comment">/** 下一个节点 **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">FilterHandler</span> <span class="variable">successor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccessor</span><span class="params">(FilterHandler successor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.successor = successor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="comment">/** 执行自身方法 **/</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> doFilter(content);</span><br><span class="line">        <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;校验不通过&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> isValid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 执行下一个节点链路 **/</span></span><br><span class="line">        <span class="keyword">if</span> (successor != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span> != successor) &#123;</span><br><span class="line">            isValid = successor.filter(content);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 每个节点过滤方法 **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">doFilter</span><span class="params">(String content)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AaaContentFilterHandler</span> <span class="keyword">extends</span> <span class="title class_">FilterHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">KEY_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doFilter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> isValid;</span><br><span class="line">        &#125;</span><br><span class="line">        isValid = !content.contains(KEY_CONTENT);</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它过滤器代码</span></span><br></pre></td></tr></table></figure>

<p>具体过滤器已经编写完成，接下来构造过滤器责任链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterHandlerChain</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">FilterHandler</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">FilterHandler</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FilterHandler</span> <span class="variable">aaaHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AaaContentFilterHandler</span>();</span><br><span class="line">        <span class="type">FilterHandler</span> <span class="variable">bbbHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BbbContentFilterHandler</span>();</span><br><span class="line">        <span class="type">FilterHandler</span> <span class="variable">cccHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CccContentFilterHandler</span>();</span><br><span class="line">        addHandler(aaaHandler);</span><br><span class="line">        addHandler(bbbHandler);</span><br><span class="line">        addHandler(cccHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHandler</span><span class="params">(FilterHandler handler)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            head = tail = handler;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 设置当前tail继任者 **/</span></span><br><span class="line">        tail.setSuccessor(handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 指针重新指向tail **/</span></span><br><span class="line">        tail = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == head) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;FilterHandlerChain is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** head发起调用 **/</span></span><br><span class="line">        <span class="keyword">return</span> head.filter(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;classpath*:META-INF/chain/spring-core.xml&quot;</span> &#125;);</span><br><span class="line">        <span class="type">FilterHandlerChain</span> <span class="variable">chain</span> <span class="operator">=</span> (FilterHandlerChain) context.getBean(<span class="string">&quot;filterHandlerChain&quot;</span>);</span><br><span class="line">        System.out.println(context);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result1</span> <span class="operator">=</span> chain.filter(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result2</span> <span class="operator">=</span> chain.filter(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;校验结果1=&quot;</span> + result1);</span><br><span class="line">        System.out.println(<span class="string">&quot;校验结果2=&quot;</span> + result2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-全链路执行"><a href="#2-2-全链路执行" class="headerlink" title="2.2 全链路执行"></a>2.2 全链路执行</h3><p>我们实现一个考题生成功能。在线考试系统根据不同年级生成不同考题。系统设置三个考题生成器，每个生成器都会执行，根据学生年级决定是否生成考题，无需生成则执行下一个生成器。</p>
<h4 id="1-实现方式一-1"><a href="#1-实现方式一-1" class="headerlink" title="(1) 实现方式一"></a>(1) 实现方式一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">QuestionGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Question <span class="title function_">generateQuestion</span><span class="params">(String gradeInfo)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AaaQuestionGenerator</span> <span class="keyword">implements</span> <span class="title class_">QuestionGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Question <span class="title function_">generateQuestion</span><span class="params">(String gradeInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!gradeInfo.equals(<span class="string">&quot;一年级&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Question</span>();</span><br><span class="line">        question.setId(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        question.setScore(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> question;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它生成器代码</span></span><br></pre></td></tr></table></figure>

<p>具体生成器已经编写完成，接下来构造生成器责任链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionChain</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;QuestionGenerator&gt; generators = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;QuestionGenerator&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">QuestionGenerator</span> <span class="variable">aaaQuestionGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AaaQuestionGenerator</span>();</span><br><span class="line">        <span class="type">QuestionGenerator</span> <span class="variable">bbbQuestionGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BbbQuestionGenerator</span>();</span><br><span class="line">        <span class="type">QuestionGenerator</span> <span class="variable">cccQuestionGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CccQuestionGenerator</span>();</span><br><span class="line">        generators.add(aaaQuestionGenerator);</span><br><span class="line">        generators.add(bbbQuestionGenerator);</span><br><span class="line">        generators.add(cccQuestionGenerator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Question&gt; <span class="title function_">generate</span><span class="params">(String gradeInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(generators)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;QuestionChain is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Question&gt; questions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Question&gt;();</span><br><span class="line">        <span class="keyword">for</span> (QuestionGenerator generator : generators) &#123;</span><br><span class="line">            <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> generator.generateQuestion(gradeInfo);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == question) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            questions.add(question);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> questions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;classpath*:META-INF/chain/spring-core.xml&quot;</span> &#125;);</span><br><span class="line">        System.out.println(context);</span><br><span class="line">        <span class="type">QuestionChain</span> <span class="variable">chain</span> <span class="operator">=</span> (QuestionChain) context.getBean(<span class="string">&quot;questionChain&quot;</span>);</span><br><span class="line">        List&lt;Question&gt; questions = chain.generate(<span class="string">&quot;一年级&quot;</span>);</span><br><span class="line">        System.out.println(questions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-实现方式二-1"><a href="#2-实现方式二-1" class="headerlink" title="(2) 实现方式二"></a>(2) 实现方式二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GenerateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 下一个节点 **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">GenerateHandler</span> <span class="variable">successor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccessor</span><span class="params">(GenerateHandler successor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.successor = successor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> List&lt;Question&gt; <span class="title function_">generate</span><span class="params">(String gradeInfo)</span> &#123;</span><br><span class="line">        List&lt;Question&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Question&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 执行自身方法 **/</span></span><br><span class="line">        <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> doGenerate(gradeInfo);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != question) &#123;</span><br><span class="line">            result.add(question);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 执行下一个节点链路 **/</span></span><br><span class="line">        <span class="keyword">if</span> (successor != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span> != successor) &#123;</span><br><span class="line">            List&lt;Question&gt; successorQuestions = successor.generate(gradeInfo);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != successorQuestions) &#123;</span><br><span class="line">                result.addAll(successorQuestions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** 每个节点生成方法 **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Question <span class="title function_">doGenerate</span><span class="params">(String gradeInfo)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AaaGenerateHandler</span> <span class="keyword">extends</span> <span class="title class_">GenerateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Question <span class="title function_">doGenerate</span><span class="params">(String gradeInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!gradeInfo.equals(<span class="string">&quot;一年级&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Question</span>();</span><br><span class="line">        question.setId(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        question.setScore(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> question;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它生成器代码</span></span><br></pre></td></tr></table></figure>

<p>具体生成器已经编写完成，接下来构造生成器责任链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenerateChain</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">GenerateHandler</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">GenerateHandler</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GenerateHandler</span> <span class="variable">aaaHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AaaGenerateHandler</span>();</span><br><span class="line">        <span class="type">GenerateHandler</span> <span class="variable">bbbHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BbbGenerateHandler</span>();</span><br><span class="line">        <span class="type">GenerateHandler</span> <span class="variable">cccHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CccGenerateHandler</span>();</span><br><span class="line">        addHandler(aaaHandler);</span><br><span class="line">        addHandler(bbbHandler);</span><br><span class="line">        addHandler(cccHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHandler</span><span class="params">(GenerateHandler handler)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            head = tail = handler;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 设置当前tail继任者 **/</span></span><br><span class="line">        tail.setSuccessor(handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 指针重新指向tail **/</span></span><br><span class="line">        tail = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Question&gt; <span class="title function_">generate</span><span class="params">(String gradeInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == head) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;GenerateChain is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** head发起调用 **/</span></span><br><span class="line">        <span class="keyword">return</span> head.generate(gradeInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;classpath*:META-INF/chain/spring-core.xml&quot;</span> &#125;);</span><br><span class="line">        <span class="type">GenerateChain</span> <span class="variable">chain</span> <span class="operator">=</span> (GenerateChain) context.getBean(<span class="string">&quot;generateChain&quot;</span>);</span><br><span class="line">        System.out.println(context);</span><br><span class="line">        List&lt;Question&gt; result = chain.generate(<span class="string">&quot;一年级&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-DUBBO构建过滤器链"><a href="#3-DUBBO构建过滤器链" class="headerlink" title="3 DUBBO构建过滤器链"></a>3 DUBBO构建过滤器链</h2><p>生产者和消费者最终执行对象都是过滤器链路最后一个节点，整个链路包含多个过滤器进行业务处理。我们看看生产者和消费者默认过滤器链路。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 生产者过滤器链路</span><br><span class="line">EchoFilter &gt; ClassloaderFilter &gt; GenericFilter &gt; ContextFilter &gt; </span><br><span class="line">TraceFilter &gt; TimeoutFilter &gt; MonitorFilter &gt; ExceptionFilter &gt; AbstractProxyInvoker</span><br><span class="line"></span><br><span class="line"># 消费者过滤器链路</span><br><span class="line">ConsumerContextFilter &gt; FutureFilter &gt; MonitorFilter &gt; DubboInvoker</span><br></pre></td></tr></table></figure>

<p>ProtocolFilterWrapper作为链路生成核心通过匿名类方式构建过滤器链路，我们以消费者构建过滤器链路为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProtocolFilterWrapper</span> <span class="keyword">implements</span> <span class="title class_">Protocol</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; Invoker&lt;T&gt; <span class="title function_">buildInvokerChain</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; invoker, String key, String group)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invoker = DubboInvoker</span></span><br><span class="line">        Invoker&lt;T&gt; last = invoker;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询符合条件过滤器列表</span></span><br><span class="line">        List&lt;Filter&gt; filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);</span><br><span class="line">        <span class="keyword">if</span> (!filters.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> filters.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filters.get(i);</span><br><span class="line">                <span class="keyword">final</span> Invoker&lt;T&gt; next = last;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 构造一个简化Invoker</span></span><br><span class="line">                last = <span class="keyword">new</span> <span class="title class_">Invoker</span>&lt;T&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Class&lt;T&gt; <span class="title function_">getInterface</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> invoker.getInterface();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> URL <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> invoker.getUrl();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAvailable</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> invoker.isAvailable();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Result <span class="title function_">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException &#123;</span><br><span class="line">                        <span class="comment">// 构造过滤器链路</span></span><br><span class="line">                        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> filter.invoke(next, invocation);</span><br><span class="line">                        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> AsyncRpcResult) &#123;</span><br><span class="line">                            <span class="type">AsyncRpcResult</span> <span class="variable">asyncResult</span> <span class="operator">=</span> (AsyncRpcResult) result;</span><br><span class="line">                            asyncResult.thenApplyWithContext(r -&gt; filter.onResponse(r, invoker, invocation));</span><br><span class="line">                            <span class="keyword">return</span> asyncResult;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> filter.onResponse(result, invoker, invocation);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">                        invoker.destroy();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> invoker.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Invoker&lt;T&gt; <span class="title function_">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException &#123;</span><br><span class="line">        <span class="comment">// RegistryProtocol不构造过滤器链路</span></span><br><span class="line">        <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">            <span class="keyword">return</span> protocol.refer(type, url);</span><br><span class="line">        &#125;</span><br><span class="line">        Invoker&lt;T&gt; invoker = protocol.refer(type, url);</span><br><span class="line">        <span class="keyword">return</span> buildInvokerChain(invoker, Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-文章总结"><a href="#4-文章总结" class="headerlink" title="4 文章总结"></a>4 文章总结</h2><p>面向对象设计有一个重要原则：对扩展开放对修改关闭，我认为这是最重要的面向对象设计原则，责任链模式非常好得体现了这个原则，有助于代码维护和处理复杂场景。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-02T09:27:08.000Z" title="2021/7/2 下午5:27:08">2021-07-02</time>发表</span><span class="level-item"><time dateTime="2021-07-02T09:27:08.000Z" title="2021/7/2 下午5:27:08">2021-07-02</time>更新</span><span class="level-item">几秒读完 (大约5个字)</span></div></div><div class="content"><p>责任链模式 </p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-28T10:50:40.000Z" title="2021/6/28 下午6:50:40">2021-06-28</time>发表</span><span class="level-item"><time dateTime="2021-06-28T10:50:40.000Z" title="2021/6/28 下午6:50:40">2021-06-28</time>更新</span><span class="level-item">21 分钟读完 (大约3117个字)</span></div></div><div class="content"><h2 id="阿里巴巴开源限流系统-Sentinel-全解析"><a href="#阿里巴巴开源限流系统-Sentinel-全解析" class="headerlink" title="阿里巴巴开源限流系统 Sentinel 全解析"></a>阿里巴巴开源限流系统 Sentinel 全解析</h2><h2 id="Sentinel-入门"><a href="#Sentinel-入门" class="headerlink" title="Sentinel 入门"></a>Sentinel 入门</h2><p>首先，Sentinel 不算一个特别复杂的系统 ，普通技术开发者也可以轻松理解它的原理和结构。你别看架构图上 Sentinel 的周边是一系列的其它高大山的开源中间件，这不过是一种华丽的包装，其内核 Sentinel Core 确实是非常轻巧的。</p>
<p>首先我们从它的 Hello World 开始，通过深入理解这段入门代码就可以洞悉其架构原理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>限流分为单机和分布式两种，单机限流是指限定当前进程里面的某个代码片段的 QPS 或者 并发线程数 或者 整个机器负载指数，一旦超出规则配置的数值就会抛出异常或者返回 false。我把这里的被限流的代码片段称为「临界区」。</p>
<p><img src="/../../images/640-4876551.png" alt="图片">图片</p>
<p>而分布式则需要另启一个集中的发票服务器，这个服务器针对每个指定的资源每秒只会生成一定量的票数，在执行临界区的代码之前先去集中的发票服务领票，如果领成功了就可以执行，否则就会抛出限流异常。所以分布式限流代价较高，需要多一次网络读写操作。如果读者阅读了我的小册《Redis 深度历险》，里面就提到了 Redis 的限流模块，Sentinel 限流的原理和它是类似的，只不过 Sentinel 的发票服务器是自研的，使用了 Netty 框架。</p>
<p>Sentinel 在使用上提供了两种形式，一种是异常捕获形式，一种是布尔形式。也就是当限流被触发时，是抛出异常来还是返回一个 false。下面我们看看它的异常捕获形式，这是单机版</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.Entry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.SphU;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 配置规则</span></span><br><span class="line">        List&lt;FlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">FlowRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowRule</span>();</span><br><span class="line">        rule.setResource(<span class="string">&quot;tutorial&quot;</span>);</span><br><span class="line">        <span class="comment">// QPS 不得超出 1</span></span><br><span class="line">        rule.setCount(<span class="number">1</span>);</span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        rule.setLimitApp(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载规则</span></span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">        <span class="comment">// 下面开始运行被限流作用域保护的代码</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                entry = SphU.entry(<span class="string">&quot;tutorial&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BlockException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;blocked&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                    entry.exit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>使用 Sentinel 需要我们提供限流规则，在规则的基础上，将临界区代码使用限流作用域结构包裹起来。在上面的例子中限定了 tutorial 资源的单机 QPS 不得超出 1，但是实际上它的运行 QPS 是 2，这多出来的执行逻辑就会被限制，对应的 Sphu.entry() 方法就会抛出限流异常 BlockException。下面是它的运行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INFO: <span class="built_in">log</span> base <span class="built_in">dir</span> is: /Users/qianwp/logs/csp/</span><br><span class="line">INFO: <span class="built_in">log</span> name use pid is: <span class="literal">false</span></span><br><span class="line">hello world</span><br><span class="line">blocked</span><br><span class="line">hello world</span><br><span class="line">blocked</span><br><span class="line">hello world</span><br><span class="line">blocked</span><br><span class="line">hello world</span><br><span class="line">blocked</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p>从输出中可以看出 Sentinel 在本地文件中记录了详细的限流日志，可以将这部分日志收集起来作为报警的数据源。</p>
<p>我们再看看它的 bool 形式，使用也是很简单，大同小异。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.SphO;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.RuleConstant;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 配置规则</span></span><br><span class="line">        List&lt;FlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">FlowRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowRule</span>();</span><br><span class="line">        rule.setResource(<span class="string">&quot;tutorial&quot;</span>);</span><br><span class="line">        <span class="comment">// QPS 不得超出 1</span></span><br><span class="line">        rule.setCount(<span class="number">1</span>);</span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        rule.setLimitApp(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">        rules.add(rule);</span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">        <span class="comment">// 运行被限流作用域保护的代码</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SphO.entry(<span class="string">&quot;tutorial&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    SphO.exit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;blocked&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="规则控制"><a href="#规则控制" class="headerlink" title="规则控制"></a>规则控制</h2><p>上面的例子中规则都是通过代码写死的，在实际的项目中，规则应该需要支持动态配置。这就需要有一个规则配置源，它可以是 Redis、Zookeeper 等数据库，还需要有一个规则变更通知机制和规则配置后台，允许管理人员可以在后台动态配置规则并实时下发到业务服务器进行控制。</p>
<p><img src="/../../images/640-20210628183551240.png" alt="图片"></p>
<p>有一些规则源存储不支持事件通知机制，比如关系数据库，Sentinel 也提供了定时刷新规则，比如每隔几秒来刷新内存里面的限流规则。下面是 redis 规则源定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redis 地址</span></span><br><span class="line"><span class="type">RedisConnectionConfig</span> <span class="variable">redisConf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisConnectionConfig</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">// 反序列化算法</span></span><br><span class="line">Converter&lt;String, List&lt;FlowRule&gt;&gt; converter = r -&gt; JSON.parseArray(r, FlowRule.class);</span><br><span class="line"><span class="comment">// 定义规则源，包含全量和增量部分</span></span><br><span class="line"><span class="comment">// 全量是一个字符串key，增量是 pubsub channel key</span></span><br><span class="line">ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; redisDataSource = <span class="keyword">new</span> <span class="title class_">RedisDataSource</span>&lt;List&lt;FlowRule&gt;&gt;(redisConf,<span class="string">&quot;app_key&quot;</span>, <span class="string">&quot;app_pubsub_key&quot;</span>, converter);</span><br><span class="line">FlowRuleManager.register2Property(redisDataSource.getProperty());</span><br></pre></td></tr></table></figure>

<h2 id="健康状态上报与检查"><a href="#健康状态上报与检查" class="headerlink" title="健康状态上报与检查"></a>健康状态上报与检查</h2><p>接入 Sentinel 的应用服务器需要将自己的限流状态上报到 Dashboard，这样就可以在后台实时呈现所有服务的限流状态。Sentinel 使用拉模型来上报状态，它在当前进程注册了一个 HTTP 服务，Dashboard 会定时来访问这个 HTTP 服务来获取每个服务进程的健康状况和限流信息。</p>
<p><img src="/../../images/640-20210628183551234.png" alt="图片"><br>Sentinel 需要将服务的地址以心跳包的形式上报给 Dashboard，如此 Dashboard 才知道每个服务进程的 HTTP 健康服务的具体地址。如果进程下线了，心跳包就停止了，那么对应的地址信息也会过期，如此Dashboard 就能准实时知道当前的有效进程服务列表。</p>
<p>当前版本开源的 Dashboard 不具备持久化能力，当管理员在后台修改了规则时，它会直接通过 HTTP 健康服务地址来同步服务限流规则直接控制具体服务进程。如果应用重启，规则将自动重置。如果你希望通过 Redis 来持久化规则源，那就需要自己定制 Dashboard。定制不难，实现它内置的持久化接口即可。</p>
<h2 id="分布式限流"><a href="#分布式限流" class="headerlink" title="分布式限流"></a>分布式限流</h2><p>前面我们说到分布式限流需要另起一个 Ticket Server，由它来分发 Ticket，能够获取到 Ticket 的请求才可以允许执行临界区代码，Ticket 服务器也需要提供规则输入源。</p>
<p><img src="/../../images/640-20210628184734252" alt="图片"></p>
<p>Ticket Server 是单点的，如果 Ticket Server 挂掉了，应用服务器限流将自动退化为本地模式。</p>
<h2 id="框架适配"><a href="#框架适配" class="headerlink" title="框架适配"></a>框架适配</h2><p>Sentinel 保护的临界区是代码块，通过拓展临界区的边界就可以直接适配各种框架，比如 Dubbo、SpringBoot 、GRPC 和消息队列等。每一种框架的适配器会在请求边界处统一定义临界区作用域，用户就可以完全不必手工添加熔断保护性代码，在毫无感知的情况下就自动植入了限流保护功能。</p>
<h2 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h2><p>限流在于限制流量，也就是 QPS 或者线程的并发数，还有一种情况是请求处理不稳定或者服务损坏，导致请求处理时间过长或者老是频繁抛出异常，这时就需要对服务进行降级处理。所谓的降级处理和限流处理在形式上没有明显差异，也是以同样的形式定义一个临界区，区别是需要对抛出来的异常需要进行统计，这样才可以知道请求异常的频率，有了这个指标才会触发降级。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义降级规则</span></span><br><span class="line">List&lt;DegradeRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="type">DegradeRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DegradeRule</span>();</span><br><span class="line">rule.setResource(<span class="string">&quot;tutorial&quot;</span>);</span><br><span class="line"><span class="comment">// 5s内异常不得超出10</span></span><br><span class="line">rule.setCount(<span class="number">10</span>);</span><br><span class="line">rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT);</span><br><span class="line">rule.setLimitApp(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">rules.add(rule);</span><br><span class="line">DegradeRuleManager.loadRules(rules);</span><br><span class="line"></span><br><span class="line"><span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  entry = SphU.entry(key);</span><br><span class="line">  <span class="comment">// 业务代码在这里</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">  <span class="comment">// 记录异常</span></span><br><span class="line">  <span class="keyword">if</span> (!BlockException.isBlockException(t)) &#123;</span><br><span class="line">    Tracer.trace(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">    entry.exit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>触发限流时会抛出 FlowException，触发熔断时会抛出 DegradeException，这两个异常都继承自 BlockException。</p>
<h2 id="热点限流"><a href="#热点限流" class="headerlink" title="热点限流"></a>热点限流</h2><p>还有一种特殊的动态限流规则，用于限制动态的热点资源。内部采用 LRU 算法计算出 topn 热点资源，然后对 topn 的资源进行限流，同时还提供特殊资源特殊对待的参数设置。<br>比如在下面的例子中限定了同一个用户的访问频次，同时也限定了同一本书的访问频次，但是对于某个特殊用户和某个特殊的书进行了特殊的频次设置。</p>
<p><img src="/../../images/640-4876551.jpeg" alt="图片">图片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ParamFlowRule</span> <span class="variable">ruleUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParamFlowRule</span>();</span><br><span class="line"><span class="comment">// 同样的 userId QPS 不得超过 10</span></span><br><span class="line">ruleUser.setParamIdx(<span class="number">0</span>).setCount(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// qianwp用户特殊对待，QPS 上限是 100</span></span><br><span class="line"><span class="type">ParamFlowItem</span> <span class="variable">uitem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParamFlowItem</span>(<span class="string">&quot;qianwp&quot;</span>, <span class="number">100</span>, String.class);</span><br><span class="line">ruleUser.setParamFlowItemList(Collections.singletonList(uitem));</span><br><span class="line"></span><br><span class="line"><span class="type">ParamFlowRule</span> <span class="variable">ruleBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParamFlowRule</span>();</span><br><span class="line"><span class="comment">// 同样的 bookId QPS 不得超过 20</span></span><br><span class="line">ruleBook.setParamIdx(<span class="number">1</span>).setCount(<span class="number">20</span>);</span><br><span class="line"><span class="comment">// redis 的书特殊对待，QPS 上限是 100</span></span><br><span class="line"><span class="type">ParamFlowItem</span> <span class="variable">bitem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParamFlowItem</span>(<span class="string">&quot;redis&quot;</span>, <span class="number">100</span>, String.class);</span><br><span class="line">ruleBook.setParamFlowItemList(Collections.singletonList(item));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载规则</span></span><br><span class="line">List&lt;ParamFlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">rules.add(ruleUser);</span><br><span class="line">rules.add(ruleBook);</span><br><span class="line">ParamFlowRuleManager.loadRules(rules)；</span><br><span class="line"></span><br><span class="line"><span class="comment">// userId的用户访问bookId的书</span></span><br><span class="line"><span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> Sphu.entry(key, EntryType.IN, <span class="number">1</span>, userId, bookId);</span><br></pre></td></tr></table></figure>


<p>热点限流的难点在于如何统计定长滑动窗口时间内的热点资源的访问量，Sentinel 设计了一个特别的数据结构叫 LeapArray，内部有较为复杂的算法设计后续需要单独分析。</p>
<h2 id="系统自适应限流-——-过载保护"><a href="#系统自适应限流-——-过载保护" class="headerlink" title="系统自适应限流 —— 过载保护"></a>系统自适应限流 —— 过载保护</h2><p>当系统的负载较高时，为了避免系统被洪水般的请求冲垮，需要对当前的系统进行限流保护。保护的方式是逐步限制 QPS，观察到系统负载恢复后，再逐渐放开 QPS，如果系统的负载又下降了，就再逐步降低 QPS。如此达到一种动态的平衡，这里面涉及到一个特殊的保持平衡的算法。系统的负载指数存在一个问题，它取自操作系统负载的 load1 参数，load1 参数更新的实时性不足，从 load1 超标到恢复的过程存在一个较长的过渡时间，如果使用一刀切方案，在这段恢复时间内阻止任何请求，待 load1 恢复后又立即放开请求，势必会导致负载的大起大落，服务处理的时断时开。为此作者将 TCP 拥塞控制算法的思想移植到这里实现了系统平滑的过载保护功能。这个算法很精巧，代码实现并不复杂，效果却是非常显著。</p>
<p>算法定义了一个稳态公式，稳态一旦打破，系统负载就会出现波动。算法的本质就是当稳态被打破时，通过持续调整相关参数来重新建立稳态。</p>
<p><img src="/../../images/640-20210628183551258" alt="图片">图片</p>
<p>稳态公式很简单：ThreadNum * (1&#x2F;ResponseTime) &#x3D; QPS，这个公式很好理解，就是系统的 QPS 等于线程数乘以单个线程每秒可以执行的请求数量。系统会实时采样统计所有临界区的 QPS 和 ResponseTime，就可以计算出相应的稳态并发线程数。当负载超标时，通过判定当前的线程数是否超出稳态线程数就可以明确是否需要拒绝当前的请求。</p>
<p>定义自适应限流规则需要提供多个参数</p>
<ol>
<li><p>系统的负载水平线，超过这个值时触发过载保护功能</p>
</li>
<li><p>当过载保护超标时，允许的最大线程数、最长响应时间和最大 QPS，可以不设置</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SystemRule&gt; rules = new ArrayList&lt;SystemRule&gt;();</span><br><span class="line">SystemRule rule = new SystemRule();</span><br><span class="line">rule.setHighestSystemLoad(3.0);</span><br><span class="line">rule.setAvgRt(10);</span><br><span class="line">rule.setQps(20);</span><br><span class="line">rule.setMaxThread(10);</span><br><span class="line">rules.add(rule);</span><br><span class="line">SystemRuleManager.loadRules(Collections.singletonList(rule));</span><br></pre></td></tr></table></figure>


<p>从代码中也可以看出系统自适应限流规则不需要定义资源名称，因为它是全局的规则，会自动应用到所有的临界区。如果当负载超标时，所有临界区资源将一起勒紧裤腰带渡过难关。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-28T10:35:23.000Z" title="2021/6/28 下午6:35:23">2021-06-28</time>发表</span><span class="level-item"><time dateTime="2021-06-28T10:35:23.000Z" title="2021/6/28 下午6:35:23">2021-06-28</time>更新</span><span class="level-item">2 分钟读完 (大约346个字)</span></div></div><div class="content"><h1 id="2-4-60中间件介绍"><a href="#2-4-60中间件介绍" class="headerlink" title="2.4.60中间件介绍"></a>2.4.60中间件介绍</h1><h2 id="一、分布式消息中间件"><a href="#一、分布式消息中间件" class="headerlink" title="一、分布式消息中间件"></a>一、分布式消息中间件</h2><h4 id="1-1ActiveMQ"><a href="#1-1ActiveMQ" class="headerlink" title="1.1ActiveMQ -"></a>1.1ActiveMQ -</h4><h4 id="1-2RabbitMQ"><a href="#1-2RabbitMQ" class="headerlink" title="1.2RabbitMQ"></a>1.2RabbitMQ</h4><h4 id="1-3Kafka-性能最高，不支持事务，持久化"><a href="#1-3Kafka-性能最高，不支持事务，持久化" class="headerlink" title="1.3Kafka - 性能最高，不支持事务，持久化"></a>1.3Kafka - 性能最高，不支持事务，持久化</h4><h4 id="1-4RocketMQ-阿里滴滴开发，后续不一定会更新"><a href="#1-4RocketMQ-阿里滴滴开发，后续不一定会更新" class="headerlink" title="1.4RocketMQ - 阿里滴滴开发，后续不一定会更新"></a>1.4RocketMQ - 阿里滴滴开发，后续不一定会更新</h4><p><strong>使用场景：</strong></p>
<p>​	消息中间件监控数据<br>​	异步数据传输场景<br>​	削峰填谷<br>​	任务调度<br>​	海量数据同步场景<br>​	分布式事务场景<br>​	日志管理场景<br>​	大数据分析场景</p>
<h2 id="二、负载均衡"><a href="#二、负载均衡" class="headerlink" title="二、负载均衡"></a>二、负载均衡</h2><p>1.Nginx</p>
<p>2.LVS负载均衡</p>
<p>3.KeepAlive</p>
<p>4.CDN</p>
<h2 id="三、缓存中间件"><a href="#三、缓存中间件" class="headerlink" title="三、缓存中间件"></a>三、缓存中间件</h2><p>1.MemCache </p>
<p>2.Redis - 分布式架构</p>
<h2 id="四、数据库中间件"><a href="#四、数据库中间件" class="headerlink" title="四、数据库中间件"></a>四、数据库中间件</h2><p>1.Mycat</p>
<p>2.ShardingJDBC</p>
<h2 id="五、案例分析"><a href="#五、案例分析" class="headerlink" title="五、案例分析"></a>五、案例分析</h2><p>算法数据保存<br>订单数据的消息分发<br>分布式事务<br>海量的容错<br>分布式锁<br>分布式会话<br>分库分表</p>
<h3 id="何谓分布式系统呢？"><a href="#何谓分布式系统呢？" class="headerlink" title="何谓分布式系统呢？"></a>何谓分布式系统呢？</h3><p>就是一个请求由服务器端的多个服务协同处理完成。和单体架构不同的是，单体架构是一个请求发起jvm调度线程（确切的是tomcat线程池）分配线程Thread来处理请求直到释放，而分布式系统：一个请求是有多个系统共同来协同完成，jvm和环境都是独立的。</p>
<h3 id="如何选择一个中间件？"><a href="#如何选择一个中间件？" class="headerlink" title="如何选择一个中间件？"></a>如何选择一个中间件？</h3><p>1.是否支持集群 - 高可用<br>2.是否跨平台 -<br>3.持久化功能 - 高可靠</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/7/">上一页</a></div><div class="pagination-next"><a href="/page/9/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><a class="pagination-link is-current" href="/page/8/">8</a></li><li><a class="pagination-link" href="/page/9/">9</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/15/">15</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Tonygeli"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Tonygeli</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>SH</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">147</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/tonygeli" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux%E5%91%BD%E4%BB%A4/"><span class="level-start"><span class="level-item">Linux命令</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringBoot/"><span class="level-start"><span class="level-item">SpringBoot</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="level-start"><span class="level-item">中间件</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/"><span class="level-start"><span class="level-item">时间管理</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">网络</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AF%BB%E4%B9%A6/"><span class="level-start"><span class="level-item">读书</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Bean/"><span class="tag">Bean</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Icarus/"><span class="tag">Icarus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySql/"><span class="tag">MySql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Netty/"><span class="tag">Netty</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Stream/"><span class="tag">Stream</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TCP/"><span class="tag">TCP</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZooKeeper/"><span class="tag">ZooKeeper</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/"><span class="tag">代码优化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="tag">公众号</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="tag">分布式事务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"><span class="tag">单点登录</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"><span class="tag">大数据</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E7%A8%8B/"><span class="tag">线程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D/"><span class="tag">自动装配</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-10T14:21:17.411Z">2022-05-10</time></p><p class="title"><a href="/2022/05/10/213Linux/13002Linux%E5%91%BD%E4%BB%A4find/">Linux命令find</a></p><p class="categories"><a href="/categories/Linux%E5%91%BD%E4%BB%A4/">Linux命令</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-10T06:58:05.176Z">2022-05-10</time></p><p class="title"><a href="/2022/05/10/3.%E8%AF%BB%E4%B9%A6/%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E6%97%B6%E9%97%B4/">职场上如何管理时间</a></p><p class="categories"><a href="/categories/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/">时间管理</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-09T06:10:31.715Z">2022-05-09</time></p><p class="title"><a href="/2022/05/09/15000%E5%AE%B9%E5%99%A8%E8%BF%90%E7%BB%B4/15030k8s-Master/">Kubernetes架构与工作流程及核心概念</a></p><p class="categories"><a href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-08T15:13:17.249Z">2022-05-08</time></p><p class="title"><a href="/2022/05/08/213Linux/13001Linux%E5%91%BD%E4%BB%A4lsof/">Linux虚拟文件系统</a></p><p class="categories"><a href="/categories/Linux%E5%91%BD%E4%BB%A4/">Linux命令</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-08T13:02:44.791Z">2022-05-08</time></p><p class="title"><a href="/2022/05/08/3.%E8%AF%BB%E4%B9%A6/Kubernetes%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetes从入门到实践</a></p><p class="categories"><a href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></p></div></article></div></div><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="LILAIQUN" height="28"></a><p class="is-size-7"><span>&copy; 2022 Tonygeli</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>