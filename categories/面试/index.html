<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>分类: 面试 - LILAIQUN</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="LILAIQUN"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="LILAIQUN"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="LILAIQUN"><meta property="og:url" content="https://tonygeli.github.io/"><meta property="og:site_name" content="LILAIQUN"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://tonygeli.github.io/img/og_image.png"><meta property="article:author" content="Tonygeli"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://tonygeli.github.io"},"headline":"LILAIQUN","image":["https://tonygeli.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Tonygeli"},"publisher":{"@type":"Organization","name":"LILAIQUN","logo":{"@type":"ImageObject","url":"https://tonygeli.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?1ecc72096a22e2426f0bc13519c3c3c7";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="LILAIQUN" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/article-17">Share</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">面试</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12008%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%80%9A%E8%AE%AF/"><img class="fill" src="/../../images/cover8.jpg" alt="线程之间如何进行通讯"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-16T10:18:24.850Z" title="2022/5/16 下午6:18:24">2022-05-16</time>发表</span><span class="level-item"><time dateTime="2022-05-16T10:22:03.593Z" title="2022/5/16 下午6:22:03">2022-05-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">几秒读完 (大约80个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12008%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%80%9A%E8%AE%AF/">线程之间如何进行通讯</a></h1><div class="content"><h1 id="线程之间如何进行通讯"><a href="#线程之间如何进行通讯" class="headerlink" title="线程之间如何进行通讯"></a>线程之间如何进行通讯</h1><p>1.线程之间可以通过共享内存</p>
<pre><code>- 1.1如果是通过共享内存来进行通信，需要考虑并发问题
- 1.2Java中Object阻塞和唤醒的`wait() notify()` 
</code></pre>
<p>2.基于网络来进行通信</p>
<p>​	并发时，通过加锁保证线程安全</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12007%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E6%AD%BB%E9%94%81/"><img class="fill" src="/../../images/cover7.jpg" alt="如何查看线程死锁"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-16T10:14:45.012Z" title="2022/5/16 下午6:14:45">2022-05-16</time>发表</span><span class="level-item"><time dateTime="2022-05-16T10:18:14.799Z" title="2022/5/16 下午6:18:14">2022-05-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">几秒读完 (大约103个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12007%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E6%AD%BB%E9%94%81/">如何查看线程死锁</a></h1><div class="content"><h1 id="如何查看线程死锁"><a href="#如何查看线程死锁" class="headerlink" title="如何查看线程死锁"></a>如何查看线程死锁</h1><p>1.可以通过<code>jstack</code>命令来查看，会显示发生死锁的线程</p>
<p>2.线程操作数据库时，数据库发生了死锁，可以查询死锁情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.查询是否锁表</span><br><span class="line">show OPEN TABLES where In_use &gt; 0;</span><br><span class="line">2.查询进程</span><br><span class="line">show processlist;</span><br><span class="line">3.查看正在锁的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;</span><br><span class="line">4.查看等待锁的事务</span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/15/12000%E9%9D%A2%E8%AF%95/12006CPU%E8%BF%87%E9%AB%98%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5/"><img class="fill" src="/../../images/cover6.jpg" alt="CPU过高如何排查"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-15T15:22:11.939Z" title="2022/5/15 下午11:22:11">2022-05-15</time>发表</span><span class="level-item"><time dateTime="2022-05-15T15:41:21.135Z" title="2022/5/15 下午11:41:21">2022-05-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">43 分钟读完 (大约6513个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/15/12000%E9%9D%A2%E8%AF%95/12006CPU%E8%BF%87%E9%AB%98%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5/">CPU过高如何排查</a></h1><div class="content"><h1 id="Linux-CPU过高如何排查"><a href="#Linux-CPU过高如何排查" class="headerlink" title="Linux CPU过高如何排查"></a>Linux CPU过高如何排查</h1><blockquote>
<p>引用：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Y2-so8CFfXv5bM4sN4aJSw">https://mp.weixin.qq.com/s/Y2-so8CFfXv5bM4sN4aJSw</a></p>
</blockquote>
<h3 id="CPU指标解析"><a href="#CPU指标解析" class="headerlink" title="CPU指标解析"></a>CPU指标解析</h3><ul>
<li><p>平均负载</p>
</li>
<li><ul>
<li>如果平均负载大于逻辑 CPU 个数，则负载比较重</li>
</ul>
</li>
<li><p>进程上下文切换</p>
</li>
<li><ul>
<li>无法获取资源而导致的自愿上下文切换</li>
<li>被系统强制调度导致的非自愿上下文切换</li>
</ul>
</li>
<li><p>CPU 使用率</p>
</li>
<li><ul>
<li>用户 CPU 使用率，包括用户态 CPU 使用率（user）和低优先级用户态 CPU 使用率（nice），表示 CPU 在用户态运行的时间百分比。用户 CPU 使用率高，通常说明有应用程序比较繁忙</li>
<li>系统 CPU 使用率，表示 CPU 在内核态运行的时间百分比（不包括中断），系统 CPU 使用率高，说明内核比较繁忙</li>
<li>等待 I&#x2F;O 的 CPU 使用率，通常也称为 iowait，表示等待 I&#x2F;O 的时间百分比。iowait 高，说明系统与硬件设备的 I&#x2F;O 交互时间比较长</li>
<li>软中断和硬中断的 CPU 使用率，分别表示内核调用软中断处理程序、硬中断处理程序的时间百分比。它们的使用率高，表明系统发生了大量的中断</li>
</ul>
</li>
</ul>
<h3 id="查看系统的平均负载"><a href="#查看系统的平均负载" class="headerlink" title="查看系统的平均负载"></a>查看系统的平均负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">uptime</span></span><br><span class="line">当前时间                   平均负载        1分钟 5分钟 15分钟</span><br><span class="line">23:24  up  7:52, 2 <span class="built_in">users</span>, load averages: 1.73 2.07 2.</span><br></pre></td></tr></table></figure>

<ul>
<li><p>平均负载与 CPU 使用率关系</p>
</li>
<li><ul>
<li>CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的</li>
<li>I&#x2F;O 密集型进程，等待 I&#x2F;O 也会导致平均负载升高，但 CPU 使用率不一定很高</li>
<li>大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高</li>
</ul>
</li>
</ul>
<h3 id="CPU-上下文切换"><a href="#CPU-上下文切换" class="headerlink" title="CPU 上下文切换"></a>CPU 上下文切换</h3><ul>
<li><p>进程上下文切换：</p>
</li>
<li><ul>
<li>进程的运行空间可以分为内核空间和用户空间，当代码发生系统调用时（访问受限制的资源），CPU 会发生上下文切换，系统调用结束时，CPU 则再从内核空间换回用户空间。一次系统调用，两次 CPU 上下文切换</li>
<li>系统平时会按一定的策略调用进程，会导致进程上下文切换</li>
<li>进程在阻塞等到访问资源时，也会发生上下文切换</li>
<li>进程通过睡眠函数挂起，会发生上下文切换</li>
<li>当有优先级更高的进程运行时，为了保证高优先级进程的运行，当前进程会被挂起</li>
</ul>
</li>
<li><p>线程上下文切换：</p>
</li>
<li><ul>
<li>同一进程里的线程，它们共享相同的虚拟内存和全局变量资源，线程上下文切换时，这些资源不变</li>
<li>线程自己的私有数据，比如栈和寄存器等，需要在上下文切换时保存切换</li>
</ul>
</li>
<li><p>中断上下文切换：</p>
</li>
<li><ul>
<li>为了快速响应硬件的事件，中断处理会打断进程的正常调度和执行，转而调用中断处理程序，响应设备事件</li>
</ul>
</li>
</ul>
<h3 id="查看系统的上下文切换情况："><a href="#查看系统的上下文切换情况：" class="headerlink" title="查看系统的上下文切换情况："></a>查看系统的上下文切换情况：</h3><p>vmstat 和 pidstat。vmvmstat 可查看系统总体的指标，pidstat则详细到每一个进程服务的指标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vmstat 2 1 </span><br><span class="line">procs --------memory--------- --swap-- --io--- -system-- ----cpu----- </span><br><span class="line">r b swpd free    buff   cache  si so  bi bo <span class="keyword">in</span> cs us sy <span class="built_in">id</span> wa st </span><br><span class="line">1 0    0 3498472 315836 3819540 0 0   0  1  2  0  3  1  96 0  0</span><br><span class="line"></span><br><span class="line">--------</span><br><span class="line">cs（context switch）是每秒上下文切换的次数</span><br><span class="line"><span class="keyword">in</span>（interrupt）则是每秒中断的次数</span><br><span class="line">r（Running or Runnable）是就绪队列的长度，也就是正在运行和等待 CPU 的进程数.当这个值超过了CPU数目，就会出现CPU瓶颈</span><br><span class="line">b（Blocked）则是处于不可中断睡眠状态的进程数</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pidstat -w</span></span><br><span class="line">Linux 3.10.0-862.el7.x86_64 (8f57ec39327b)      07/11/2021      _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">06:43:23 PM   UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">06:43:23 PM     0         1      0.00      0.00  java</span><br><span class="line">06:43:23 PM     0       102      0.00      0.00  bash</span><br><span class="line">06:43:23 PM     0       150      0.00      0.00  pidstat</span><br><span class="line"></span><br><span class="line">------各项指标解析---------------------------</span><br><span class="line">PID       进程<span class="built_in">id</span></span><br><span class="line">Cswch/s   每秒主动任务上下文切换数量</span><br><span class="line">Nvcswch/s 每秒被动任务上下文切换数量。大量进程都在争抢 CPU 时，就容易发生非自愿上下文切换</span><br><span class="line">Command   进程执行命令</span><br></pre></td></tr></table></figure>

<h3 id="怎么排查-CPU-过高问题"><a href="#怎么排查-CPU-过高问题" class="headerlink" title="怎么排查 CPU 过高问题"></a>怎么排查 CPU 过高问题</h3><ul>
<li>先使用 top 命令，查看系统相关指标。如需要按某指标排序则 使用 <code>top -o 字段名</code> 如：<code>top -o %CPU</code>。<code> -o</code> 可以指定排序字段，顺序从大到小</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># top -o %MEM</span></span><br><span class="line">top - 18:20:27 up 26 days,  8:30,  2 <span class="built_in">users</span>,  load average: 0.04, 0.09, 0.13</span><br><span class="line">Tasks: 168 total,   1 running, 167 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.3 us,  0.5 sy,  0.0 ni, 99.1 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.1 si,  0.0 st</span><br><span class="line">KiB Mem:  32762356 total, 14675196 used, 18087160 free,      884 buffers</span><br><span class="line">KiB Swap:  2103292 total,        0 used,  2103292 free.  6580028 cached Mem</span><br><span class="line"></span><br><span class="line">PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND         </span><br><span class="line">2323 mysql     20   0 19.918g 4.538g   9404 S 0.333 14.52 352:51.44 mysqld   </span><br><span class="line">1260 root      20   0 7933492 1.173g  14004 S 0.333 3.753  58:20.74 java   </span><br><span class="line">1520 daemon    20   0  358140   3980    776 S 0.333 0.012   6:19.55 httpd    </span><br><span class="line">1503 root      20   0   69172   2240   1412 S 0.333 0.007   0:48.05 httpd                       </span><br><span class="line">                   </span><br><span class="line">---------各项指标解析---------------------------------------------------</span><br><span class="line">第一行统计信息区</span><br><span class="line">    18:20:27                     当前时间</span><br><span class="line">    up 25 days, 17:29             系统运行时间，格式为时:分</span><br><span class="line">    1 user                     当前登录用户数</span><br><span class="line">    load average: 0.04, 0.09, 0.13  系统负载，三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值</span><br><span class="line"></span><br><span class="line">Tasks：进程相关信息</span><br><span class="line">    running   正在运行的进程数</span><br><span class="line">    sleeping  睡眠的进程数</span><br><span class="line">    stopped   停止的进程数</span><br><span class="line">    zombie    僵尸进程数</span><br><span class="line">Cpu(s)：CPU相关信息</span><br><span class="line">    %us：表示用户空间程序的cpu使用率（没有通过<span class="built_in">nice</span>调度）</span><br><span class="line">    %sy：表示系统空间的cpu使用率，主要是内核程序</span><br><span class="line">    %ni：表示用户空间且通过<span class="built_in">nice</span>调度过的程序的cpu使用率</span><br><span class="line">    %<span class="built_in">id</span>：空闲cpu</span><br><span class="line">    %wa：cpu运行时在等待io的时间</span><br><span class="line">    %hi：cpu处理硬中断的数量</span><br><span class="line">    %si：cpu处理软中断的数量</span><br><span class="line">Mem  内存信息  </span><br><span class="line">    total 物理内存总量</span><br><span class="line">    used 使用的物理内存总量</span><br><span class="line">    free 空闲内存总量</span><br><span class="line">    buffers 用作内核缓存的内存量</span><br><span class="line">Swap 内存信息  </span><br><span class="line">    total 交换区总量</span><br><span class="line">    used 使用的交换区总量</span><br><span class="line">    free 空闲交换区总量</span><br><span class="line">    cached 缓冲的交换区总量</span><br></pre></td></tr></table></figure>

<ul>
<li><p>找到相关进程后，我们则可以使用 <code>top -Hp pid</code> 或 <code>pidstat -t -p pid</code> 命令查看进程具体线程使用 CPU 情况，从而找到具体的导致 CPU 高的线程</p>
</li>
<li><ul>
<li>%us 过高，则可以在对应 java 服务根据线程ID查看具体详情，是否存在死循环，或者长时间的阻塞调用。java 服务可以使用 jstack</li>
<li>如果是 %sy 过高，则先使用 strace 定位具体的系统调用，再定位是哪里的应用代码导致的</li>
<li>如果是 %si 过高，则可能是网络问题导致软中断频率飙高</li>
<li>%wa 过高，则是频繁读写磁盘导致的。</li>
</ul>
</li>
</ul>
<h2 id="linux-内存"><a href="#linux-内存" class="headerlink" title="linux 内存"></a><strong>linux 内存</strong></h2><h3 id="查看内存使用情况"><a href="#查看内存使用情况" class="headerlink" title="查看内存使用情况"></a>查看内存使用情况</h3><ul>
<li>使用 top 或者 free、vmstat 命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># top </span></span><br><span class="line">top - 18:20:27 up 26 days,  8:30,  2 <span class="built_in">users</span>,  load average: 0.04, 0.09, 0.13</span><br><span class="line">Tasks: 168 total,   1 running, 167 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.3 us,  0.5 sy,  0.0 ni, 99.1 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.1 si,  0.0 st</span><br><span class="line">KiB Mem:  32762356 total, 14675196 used, 18087160 free,      884 buffers</span><br><span class="line">KiB Swap:  2103292 total,        0 used,  2103292 free.  6580028 cached Mem</span><br><span class="line"></span><br><span class="line">PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND         </span><br><span class="line">2323 mysql     20   0 19.918g 4.538g   9404 S 0.333 14.52 352:51.44 mysqld   </span><br><span class="line">1260 root      20   0 7933492 1.173g  14004 S 0.333 3.753  58:20.74 java       </span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<ul>
<li><p>bcc-tools 软件包里的 cachestat 和 cachetop、memleak</p>
</li>
<li><ul>
<li>achestat 可查看整个系统缓存的读写命中情况</li>
<li>cachetop 可查看每个进程的缓存命中情况</li>
<li>memleak 可以用检查 C、C++ 程序的内存泄漏问题</li>
</ul>
</li>
</ul>
<h3 id="free-命令内存指标"><a href="#free-命令内存指标" class="headerlink" title="free 命令内存指标"></a>free 命令内存指标</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># free -m </span></span><br><span class="line">                total used   free   shared  buffers  cached </span><br><span class="line">Mem:            32107 30414  1692   0       1962     8489 </span><br><span class="line">-/+ buffers/cache:    19962  12144 </span><br><span class="line">Swap:               0     0     0</span><br></pre></td></tr></table></figure>

<ul>
<li>shared 是共享内存的大小, 一般系统不会用到，总是0</li>
<li>buffers&#x2F;cache 是缓存和缓冲区的大小，buffers 是对原始磁盘块的缓存，cache 是从磁盘读取文件系统里文件的页缓存</li>
<li>available 是新进程可用内存的大小</li>
</ul>
<h3 id="内存-swap-过高"><a href="#内存-swap-过高" class="headerlink" title="内存 swap 过高"></a>内存 swap 过高</h3><p>Swap 其实就是把一块磁盘空间或者一个本地文件，当成内存来使用。swap 换出，把进程暂时不用的内存数据存储到磁盘中，并释放这些数据占用的内存。swap 换入，在进程再次访问这些内存的时候，把它们从磁盘读到内存中来</p>
<ul>
<li><p>swap 和 内存回收的机制</p>
</li>
<li><ul>
<li>内存的回收既包括了文件页（内存映射获取磁盘文件的页）又包括了匿名页（进程动态分配的内存）</li>
<li>对文件页的回收，可以直接回收缓存，或者把脏页写回磁盘后再回收</li>
<li>而对匿名页的回收，其实就是通过 Swap 机制，把它们写入磁盘后再释放内存</li>
</ul>
</li>
<li><p>swap 过高会造成严重的性能问题，页失效会导致频繁的页面在内存和磁盘之间交换</p>
</li>
<li><ul>
<li>一般线上的服务器的内存都很大，可以禁用 swap</li>
<li>可以设置 &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;min_free_kbytes，来调整系统定期回收内存的阈值，也可以设置 &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;swappiness，来调整文件页和匿名页的回收倾向</li>
</ul>
</li>
</ul>
<h2 id="linux-磁盘I-x2F-O-问题"><a href="#linux-磁盘I-x2F-O-问题" class="headerlink" title="linux 磁盘I&#x2F;O 问题"></a><strong>linux 磁盘I&#x2F;O 问题</strong></h2><h3 id="文件系统和磁盘"><a href="#文件系统和磁盘" class="headerlink" title="文件系统和磁盘"></a>文件系统和磁盘</h3><ul>
<li>磁盘是一个存储设备（确切地说是块设备），可以被划分为不同的磁盘分区。而在磁盘或者磁盘分区上，还可以再创建文件系统，并挂载到系统的某个目录中。系统就可以通过这个挂载目录来读写文件</li>
<li>磁盘是存储数据的块设备，也是文件系统的载体。所以，文件系统确实还是要通过磁盘，来保证数据的持久化存储</li>
<li>系统在读写普通文件时，I&#x2F;O 请求会首先经过文件系统，然后由文件系统负责，来与磁盘进行交互。而在读写块设备文件时，会跳过文件系统，直接与磁盘交互</li>
<li>linux 内存里的 Buffers 是对原始磁盘块的临时存储，也就是用来缓存磁盘的数据，通常不会特别大（20MB 左右）。内核就可以把分散的写集中起来（优化磁盘的写入）</li>
<li>linux 内存里的 Cached 是从磁盘读取文件的页缓存，也就是用来缓存从文件读写的数据。下次访问这些文件数据时，则直接从内存中快速获取，而不再次访问磁盘</li>
</ul>
<h3 id="磁盘性能指标"><a href="#磁盘性能指标" class="headerlink" title="磁盘性能指标"></a>磁盘性能指标</h3><ul>
<li>使用率，是指磁盘处理 I&#x2F;O 的时间百分比。过高的使用率（比如超过 80%），通常意味着磁盘 I&#x2F;O 存在性能瓶颈。</li>
<li>饱和度，是指磁盘处理 I&#x2F;O 的繁忙程度。过高的饱和度，意味着磁盘存在严重的性能瓶颈。当饱和度为 100% 时，磁盘无法接受新的 I&#x2F;O 请求。</li>
<li>IOPS（Input&#x2F;Output Per Second），是指每秒的 I&#x2F;O 请求数</li>
<li>吞吐量，是指每秒的 I&#x2F;O 请求大小</li>
<li>响应时间，是指 I&#x2F;O 请求从发出到收到响应的间隔时间</li>
</ul>
<h3 id="IO-过高怎么找问题，怎么调优"><a href="#IO-过高怎么找问题，怎么调优" class="headerlink" title="IO 过高怎么找问题，怎么调优"></a>IO 过高怎么找问题，怎么调优</h3><ul>
<li>查看系统磁盘整体 I&#x2F;O</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># iostat -x -k -d 1 1</span></span><br><span class="line">Linux 4.4.73-5-default (ceshi44)        2021年07月08日  _x86_64_        (40 CPU)</span><br><span class="line"></span><br><span class="line">Device:  rrqm/s   wrqm/s  r/s    w/s    rkB/s   wkB/s  avgrq-sz avgqu-sz await r_await w_await  svctm  %util</span><br><span class="line">sda      0.08     2.48    0.37   11.71  27.80   507.24  88.53   0.02     1.34   14.96    0.90   0.09   0.10</span><br><span class="line">sdb      0.00     1.20    1.28   16.67  30.91   647.83  75.61   0.17     9.51    9.40    9.52   0.32   0.57</span><br><span class="line">------ </span><br><span class="line">rrqm/s:   每秒对该设备的读请求被合并次数，文件系统会对读取同块(block)的请求进行合并</span><br><span class="line">wrqm/s:   每秒对该设备的写请求被合并次数</span><br><span class="line">r/s:      每秒完成的读次数</span><br><span class="line">w/s:      每秒完成的写次数</span><br><span class="line">rkB/s:    每秒读数据量(kB为单位)</span><br><span class="line">wkB/s:    每秒写数据量(kB为单位)</span><br><span class="line">avgrq-sz: 平均每次IO操作的数据量(扇区数为单位)</span><br><span class="line">avgqu-sz: 平均等待处理的IO请求队列长度</span><br><span class="line">await:    平均每次IO请求等待时间(包括等待时间和处理时间，毫秒为单位)</span><br><span class="line">svctm:    平均每次IO请求的处理时间(毫秒为单位)</span><br><span class="line">%util:    采用周期内用于IO操作的时间比率，即IO队列非空的时间比率</span><br></pre></td></tr></table></figure>

<ul>
<li>查看进程级别 I&#x2F;O</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pidstat -d</span></span><br><span class="line">Linux 3.10.0-862.el7.x86_64 (8f57ec39327b)      07/11/2021      _x86_64_        (6 CPU)</span><br><span class="line"></span><br><span class="line">06:42:35 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command</span><br><span class="line">06:42:35 PM     0         1      1.05      0.00      0.00  java</span><br><span class="line">06:42:35 PM     0       102      0.04      0.05      0.00  bash</span><br><span class="line">------</span><br><span class="line">kB_rd/s   每秒从磁盘读取的KB</span><br><span class="line">kB_wr/s   每秒写入磁盘KB</span><br><span class="line">kB_ccwr/s 任务取消的写入磁盘的KB。当任务截断脏的pagecache的时候会发生</span><br><span class="line">Command   进程执行命令</span><br></pre></td></tr></table></figure>

<ul>
<li>当使用 pidstat -d 定位到哪个应用服务时，接下来则需要使用 strace 和 lsof 定位是哪些代码在读写磁盘里的哪些文件，导致IO高的原因</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ strace -p 18940 </span><br><span class="line">strace: Process 18940 attached </span><br><span class="line">...</span><br><span class="line">mmap(NULL, 314576896, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f0f7aee9000 </span><br><span class="line">mmap(NULL, 314576896, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f0f682e8000 </span><br><span class="line">write(3, <span class="string">&quot;2018-12-05 15:23:01,709 - __main&quot;</span>..., 314572844 </span><br><span class="line">) = 314572844 </span><br><span class="line">munmap(0x7f0f682e8000, 314576896)       = 0 </span><br><span class="line">write(3, <span class="string">&quot;\n&quot;</span>, 1)                       = 1 </span><br><span class="line">munmap(0x7f0f7aee9000, 314576896)       = 0 </span><br><span class="line">close(3)                                = 0 </span><br><span class="line"><span class="built_in">stat</span>(<span class="string">&quot;/tmp/logtest.txt.1&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=943718535, ...&#125;) = 0 </span><br></pre></td></tr></table></figure>

<ul>
<li>strace 命令输出可以看到进程18940 正在往文件 &#x2F;tmp&#x2F;logtest.txt.1 写入300m</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lsof -p 18940 </span><br><span class="line">COMMAND   PID USER   FD   TYPE DEVICE  SIZE/OFF    NODE NAME </span><br><span class="line">java  18940 root  cwd    DIR   0,50      4096 1549389 / </span><br><span class="line">… </span><br><span class="line">java  18940 root    2u   CHR  136,0       0t0       3 /dev/pts/0 </span><br><span class="line">java  18940 root    3w   REG    8,1 117944320     303 /tmp/logtest.txt </span><br><span class="line">----</span><br><span class="line">FD 表示文件描述符号，TYPE 表示文件类型，NODE NAME 表示文件路径</span><br></pre></td></tr></table></figure>

<ul>
<li>lsof 也可以看出进程18940 以每次 300MB 的速度往 &#x2F;tmp&#x2F;logtest.txt 写入</li>
</ul>
<h2 id="linux-网络I-x2F-O-问题"><a href="#linux-网络I-x2F-O-问题" class="headerlink" title="linux 网络I&#x2F;O 问题"></a><strong>linux 网络I&#x2F;O 问题</strong></h2><p>当一个网络帧到达网卡后，网卡会通过 DMA 方式，把这个网络包放到收包队列中；然后通过硬中断，告诉中断处理程序已经收到了网络包。接着，网卡中断处理程序会为网络帧分配内核数据结构（sk_buff），并将其拷贝到 sk_buff 缓冲区中；然后再通过软中断，通知内核收到了新的网络帧。内核协议栈从缓冲区中取出网络帧，并通过网络协议栈，从下到上逐层处理这个网络帧</p>
<ul>
<li>硬中断：与系统相连的外设(比如网卡、硬盘)自动产生的。主要是用来通知操作系统系统外设状态的变化。比如当网卡收到数据包的时候，就会发出一个硬中断</li>
<li>软中断：为了满足实时系统的要求，中断处理应该是越快越好。linux为了实现这个特点，当中断发生的时候，硬中断处理那些短时间就可以完成的工作，而将那些处理事件比较长的工作，交给软中断来完成</li>
</ul>
<h3 id="网络I-x2F-O指标"><a href="#网络I-x2F-O指标" class="headerlink" title="网络I&#x2F;O指标"></a>网络I&#x2F;O指标</h3><ul>
<li>带宽，表示链路的最大传输速率，单位通常为 b&#x2F;s （比特 &#x2F; 秒）</li>
<li>吞吐量，表示单位时间内成功传输的数据量，单位通常为 b&#x2F;s（比特 &#x2F; 秒）或者 B&#x2F;s（字节 &#x2F; 秒）吞吐量受带宽限制，而吞吐量 &#x2F; 带宽，也就是该网络的使用率</li>
<li>延时，表示从网络请求发出后，一直到收到远端响应，所需要的时间延迟。在不同场景中，这一指标可能会有不同含义。比如，它可以表示，建立连接需要的时间（比如 TCP 握手延时），或一个数据包往返所需的时间（比如 RTT）</li>
<li>PPS，是 Packet Per Second（包 &#x2F; 秒）的缩写，表示以网络包为单位的传输速率。PPS 通常用来评估网络的转发能力，比如硬件交换机，通常可以达到线性转发（即 PPS 可以达到或者接近理论最大值）。而基于 Linux 服务器的转发，则容易受网络包大小的影响</li>
<li>网络的连通性</li>
<li>并发连接数（TCP 连接数量）</li>
<li>丢包率（丢包百分比）</li>
</ul>
<h3 id="查看网络I-x2F-O指标"><a href="#查看网络I-x2F-O指标" class="headerlink" title="查看网络I&#x2F;O指标"></a>查看网络I&#x2F;O指标</h3><ul>
<li>查看网络配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ifconfig em1</span></span><br><span class="line">em1       Link encap:Ethernet  HWaddr 80:18:44:EB:18:98  </span><br><span class="line">          inet addr:192.168.0.44  Bcast:192.168.0.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::8218:44ff:feeb:1898/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3098067963 errors:0 dropped:5379363 overruns:0 frame:0</span><br><span class="line">          TX packets:2804983784 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:1661766458875 (1584783.9 Mb)  TX bytes:1356093926505 (1293271.9 Mb)</span><br><span class="line">          Interrupt:83</span><br><span class="line">-----</span><br><span class="line">TX 和 RX 部分的 errors、dropped、overruns、carrier 以及 collisions 等指标不为 0 时，</span><br><span class="line">通常表示出现了网络 I/O 问题。</span><br><span class="line">errors 表示发生错误的数据包数，比如校验错误、帧同步错误等</span><br><span class="line">dropped 表示丢弃的数据包数，即数据包已经收到了 Ring Buffer，但因为内存不足等原因丢包</span><br><span class="line">overruns 表示超限数据包数，即网络 I/O 速度过快，导致 Ring Buffer 中的数据包来不及处理（队列满）而导致的丢包</span><br><span class="line">carrier 表示发生 carrirer 错误的数据包数，比如双工模式不匹配、物理电缆出现问题等</span><br><span class="line">collisions 表示碰撞数据包数</span><br></pre></td></tr></table></figure>

<ul>
<li>网络吞吐和 PPS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sar -n DEV 1</span></span><br><span class="line">Linux 4.4.73-5-default (ceshi44)        2022年03月31日  _x86_64_        (40 CPU)</span><br><span class="line"></span><br><span class="line">15时39分40秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</span><br><span class="line">15时39分41秒       em1   1241.00   1022.00    600.48    590.39      0.00      0.00    165.00      0.49</span><br><span class="line">15时39分41秒        lo    636.00    636.00   7734.06   7734.06      0.00      0.00      0.00      0.00</span><br><span class="line">15时39分41秒       em4      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">15时39分41秒       em3      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">15时39分41秒       em2     26.00     20.00      6.63      8.80      0.00      0.00      0.00      0.01</span><br><span class="line">----</span><br><span class="line">rxpck/s 和 txpck/s 分别是接收和发送的 PPS，单位为包 / 秒</span><br><span class="line">rxkB/s 和 txkB/s 分别是接收和发送的吞吐量，单位是 KB/ 秒</span><br><span class="line">rxcmp/s 和 txcmp/s 分别是接收和发送的压缩数据包数，单位是包 / 秒</span><br></pre></td></tr></table></figure>

<ul>
<li>宽带</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ethtool em1 | grep Speed </span></span><br><span class="line">Speed: 1000Mb/s</span><br></pre></td></tr></table></figure>

<ul>
<li>连通性和延迟</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.a.shifen.com (14.215.177.38) 56(84) bytes of data.</span><br><span class="line">64 bytes from 14.215.177.38: icmp_seq=1 ttl=56 time=53.9 ms</span><br><span class="line">64 bytes from 14.215.177.38: icmp_seq=2 ttl=56 time=52.3 ms</span><br><span class="line">64 bytes from 14.215.177.38: icmp_seq=3 ttl=56 time=53.8 ms</span><br><span class="line">64 bytes from 14.215.177.38: icmp_seq=4 ttl=56 time=56.0 ms</span><br></pre></td></tr></table></figure>

<ul>
<li>统计 TCP 连接状态工具 ss 和 netstat</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@root ~]$&gt;<span class="comment">#ss -ant | awk &#x27;&#123;++S[$1]&#125; END &#123;for(a in S) print a, S[a]&#125;&#x27;</span></span><br><span class="line">LISTEN 96</span><br><span class="line">CLOSE-WAIT 527</span><br><span class="line">ESTAB 8520</span><br><span class="line">State 1</span><br><span class="line">SYN-SENT 2</span><br><span class="line">TIME-WAIT 660</span><br><span class="line"></span><br><span class="line">[root@root ~]$&gt;<span class="comment">#netstat -n | awk &#x27;/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;&#x27;</span></span><br><span class="line">CLOSE_WAIT 530</span><br><span class="line">ESTABLISHED 8511</span><br><span class="line">FIN_WAIT2 3</span><br><span class="line">TIME_WAIT 809</span><br></pre></td></tr></table></figure>

<h3 id="网络请求变慢，怎么调优"><a href="#网络请求变慢，怎么调优" class="headerlink" title="网络请求变慢，怎么调优"></a>网络请求变慢，怎么调优</h3><ul>
<li><p>高并发下 TCP 请求变多，会有大量处于 TIME_WAIT 状态的连接，它们会占用大量内存和端口资源。此时可以优化与 TIME_WAIT 状态相关的内核选项</p>
</li>
<li><ul>
<li>增大处于 TIME_WAIT 状态的连接数量 net.ipv4.tcp_max_tw_buckets ，并增大连接跟踪表的大小 net.netfilter.nf_conntrack_max</li>
<li>减小 net.ipv4.tcp_fin_timeout 和 net.netfilter.nf_conntrack_tcp_timeout_time_wait ，让系统尽快释放它们所占用的资源</li>
<li>开启端口复用 net.ipv4.tcp_tw_reuse。这样，被 TIME_WAIT 状态占用的端口，还能用到新建的连接中</li>
<li>增大本地端口的范围 net.ipv4.ip_local_port_range 。这样就可以支持更多连接，提高整体的并发能力</li>
<li>增加最大文件描述符的数量。可以使用 fs.nr_open 和 fs.file-max ，分别增大进程和系统的最大文件描述符数</li>
</ul>
</li>
<li><p>SYN FLOOD 攻击，利用 TCP 协议特点进行攻击而引发的性能问题，可以考虑优化与 SYN 状态相关的内核选项</p>
</li>
<li><ul>
<li>增大 TCP 半连接的最大数量 net.ipv4.tcp_max_syn_backlog ，或者开启 TCP SYN Cookies net.ipv4.tcp_syncookies ，来绕开半连接数量限制的问题</li>
<li>减少 SYN_RECV 状态的连接重传 SYN+ACK 包的次数 net.ipv4.tcp_synack_retries</li>
</ul>
</li>
<li><p>加快 TCP 长连接的回收，优化与 Keepalive 相关的内核选项</p>
</li>
<li><ul>
<li>缩短最后一次数据包到 Keepalive 探测包的间隔时间 net.ipv4.tcp_keepalive_time</li>
<li>缩短发送 Keepalive 探测包的间隔时间 net.ipv4.tcp_keepalive_intvl</li>
<li>减少 Keepalive 探测失败后，一直到通知应用程序前的重试次数 net.ipv4.tcp_keepalive_probes</li>
</ul>
</li>
</ul>
<h2 id="java-应用内存泄漏和频繁-GC"><a href="#java-应用内存泄漏和频繁-GC" class="headerlink" title="java 应用内存泄漏和频繁 GC"></a><strong>java 应用内存泄漏和频繁 GC</strong></h2><h3 id="区分内存溢出、内存泄漏、内存逃逸"><a href="#区分内存溢出、内存泄漏、内存逃逸" class="headerlink" title="区分内存溢出、内存泄漏、内存逃逸"></a>区分内存溢出、内存泄漏、内存逃逸</h3><ul>
<li><p>内存泄漏：内存被申请后始终无法释放，导致内存无法被回收使用，造成内存空间浪费</p>
</li>
<li><p>内存溢出：指内存申请时，内存空间不足</p>
</li>
<li><ul>
<li>1-内存上限过小</li>
<li>2-内存加载数据太多</li>
<li>3-分配太多内存没有回收，出现内存泄漏</li>
</ul>
</li>
<li><p>内存逃逸：是指程序运行时的数据，本应在栈上分配，但需要在堆上分配，称为内存逃逸</p>
</li>
<li><ul>
<li>java中的对象都是在堆上分配的，而垃圾回收机制会回收堆中不再使用的对象，但是筛选可回收对象，回收对象还有整理内存都需要消耗时间。如果能够通过<strong>逃逸分析</strong>确定对象不会逃出方法之外，那就可以让这个对象在栈上分配内存，对象所占用的内存就可以随栈帧出栈而销毁，就减轻了垃圾回收的压力</li>
<li>线程同步本身比较耗时，如果确定一个变量不会逃逸出线程，无法被其它线程访问到，那这个变量的读写就不会存在竞争，对这个变量的同步措施可以清除</li>
<li>java 虚拟机中的原始数据类型(int，long及reference类型等) 都不能再进一步分解，它们称为标量。如果一个数据可以继续分解，那它称为聚合量，java 中最典型的聚合量是对象。如果逃逸分析证明一个对象不会被外部访问，并且这个对象是可分解的，那程序运行时可能不创建该对象，而改为直接创建它的若干个被方法使用到的成员变量来代替。拆散后的变量便可以被单独分析与优化，可以各自分别在栈帧或寄存器上分配空间，原本的对象就无需整体分配空间</li>
</ul>
</li>
</ul>
<h3 id="内存泄漏，该如何定位和处理"><a href="#内存泄漏，该如何定位和处理" class="headerlink" title="内存泄漏，该如何定位和处理"></a>内存泄漏，该如何定位和处理</h3><ul>
<li>使用 <code>jmap -histo:live [pid]</code> 和 <code>jmap -dump:format=b,file=filename [pid]</code> 前者可以统计堆内存对象大小和数量，后者可以把堆内存 dump 下来</li>
<li>启动参数中指定<code>-XX:+HeapDumpOnOutOfMemoryError</code>来保存OOM时的dump文件</li>
<li>使用 JProfiler 或者 MAT 软件查看 heap 内存对象，可以更直观地发现泄露的对象</li>
</ul>
<p><img src="/../../images/image-20220515234040704.png" alt="image-20220515234040704"></p>
<h2 id="java线程问题排查"><a href="#java线程问题排查" class="headerlink" title="java线程问题排查"></a><strong>java线程问题排查</strong></h2><h3 id="java-线程状态"><a href="#java-线程状态" class="headerlink" title="java 线程状态"></a>java 线程状态</h3><ul>
<li><p>NEW：对应没有 Started 的线程，对应新生态</p>
</li>
<li><p>RUNNABLE：对于就绪态和运行态的合称</p>
</li>
<li><p>BLOCKED，WAITING，TIMED_WAITING：三个都是阻塞态</p>
</li>
<li><ul>
<li>sleep 和 join 称为WAITING</li>
<li>sleep 和 join 方法设置了超时时间的，则是 TIMED_WAITING</li>
<li>wait 和 IO 流阻塞称为BLOCKED</li>
</ul>
</li>
<li><p>TERMINATED：死亡态</p>
</li>
</ul>
<h3 id="线程出现死锁或者被阻塞"><a href="#线程出现死锁或者被阻塞" class="headerlink" title="线程出现死锁或者被阻塞"></a>线程出现死锁或者被阻塞</h3><ul>
<li><code>jstack –l pid | grep -i –E &#39;BLOCKED | deadlock&#39;</code> ， 加上参数 -l，jstack 命令可以快速打印出造成死锁的代码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jstack -l 28764</span></span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (13.0.2+8 mixed mode, sharing):</span><br><span class="line">.....</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span> <span class="comment">#14 prio=5 os_prio=0 cpu=0.00ms elapsed=598.37s tid=0x000001b3c25f7000 nid=0x4abc waiting for monitor entry  [0x00000061661fe000]</span></span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at com.Test<span class="variable">$DieLock</span>.run(Test.java:52)</span><br><span class="line">        - waiting to lock &lt;0x0000000712d7c230&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;0x0000000712d7c220&gt; (a java.lang.Object)</span><br><span class="line">        at java.lang.Thread.run(java.base@13.0.2/Thread.java:830)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#15 prio=5 os_prio=0 cpu=0.00ms elapsed=598.37s tid=0x000001b3c25f8000 nid=0x1984 waiting for monitor entry  [0x00000061662ff000]</span></span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at com.Test<span class="variable">$DieLock</span>.run(Test.java:63)</span><br><span class="line">        - waiting to lock &lt;0x0000000712d7c220&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;0x0000000712d7c230&gt; (a java.lang.Object)</span><br><span class="line">        at java.lang.Thread.run(java.base@13.0.2/Thread.java:830)</span><br><span class="line">.....</span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">  waiting to lock monitor 0x000001b3c1e4c480 (object 0x0000000712d7c230, a java.lang.Object),</span><br><span class="line">  <span class="built_in">which</span> is held by <span class="string">&quot;Thread-1&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">  waiting to lock monitor 0x000001b3c1e4c080 (object 0x0000000712d7c220, a java.lang.Object),</span><br><span class="line">  <span class="built_in">which</span> is held by <span class="string">&quot;Thread-0&quot;</span></span><br><span class="line"></span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">        at com.Test<span class="variable">$DieLock</span>.run(Test.java:52)</span><br><span class="line">        - waiting to lock &lt;0x0000000712d7c230&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;0x0000000712d7c220&gt; (a java.lang.Object)</span><br><span class="line">        at java.lang.Thread.run(java.base@13.0.2/Thread.java:830)</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">        at com.Test<span class="variable">$DieLock</span>.run(Test.java:63)</span><br><span class="line">        - waiting to lock &lt;0x0000000712d7c220&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;0x0000000712d7c230&gt; (a java.lang.Object)</span><br><span class="line">        at java.lang.Thread.run(java.base@13.0.2/Thread.java:830)</span><br><span class="line">Found 1 deadlock.</span><br></pre></td></tr></table></figure>

<ul>
<li>从 jstack 输出的日志可以看出线程阻塞在 Test.java:52 行，发生了死锁</li>
</ul>
<h2 id="常用-jvm-调优启动参数"><a href="#常用-jvm-调优启动参数" class="headerlink" title="常用 jvm 调优启动参数"></a><strong>常用 jvm 调优启动参数</strong></h2><ul>
<li>-verbose:gc 输出每次GC的相关情况</li>
<li>-verbose:jni 输出native方法调用的相关情况，一般用于诊断jni调用错误信息</li>
<li>-Xms n 指定jvm堆的初始大小，默认为物理内存的1&#x2F;64，最小为1M；可以指定单位，比如k、m，若不指定，则默认为字节</li>
<li>-Xmx n 指定jvm堆的最大值，默认为物理内存的1&#x2F;4或者1G，最小为2M；单位与-Xms一致</li>
<li>-Xss n 设置单个线程栈的大小，一般默认为512k</li>
<li>-XX:NewRatio&#x3D;4 设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1&#x2F;5</li>
<li>-Xmn 设置新生代内存大小。整个堆大小&#x3D;年轻代大小 + 年老代大小 + 持久代大小。持久代一般固定大小为64m，所以增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，Sun官方推荐配置为整个堆的3&#x2F;8</li>
<li>-XX:SurvivorRatio&#x3D;4 设置年轻代中Eden区与Survivor区的大小比值。设置为4，则两个Survivor区与一个Eden区的比值为2:4，一个Survivor区占整个年轻代的1&#x2F;6</li>
<li>-XX:MaxTenuringThreshold&#x3D;0 设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概率</li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/13/12000%E9%9D%A2%E8%AF%95/12005Spring%E4%BA%8B%E5%8A%A1%E5%A4%B1%E6%95%886%E7%A7%8D%E5%9C%BA%E6%99%AF/"><img class="fill" src="/../../images/cover5.jpg" alt="Spring事务失效6种场景"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-13T03:44:34.257Z" title="2022/5/13 上午11:44:34">2022-05-13</time>发表</span><span class="level-item"><time dateTime="2022-05-13T04:04:19.242Z" title="2022/5/13 下午12:04:19">2022-05-13</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">1 分钟读完 (大约117个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/13/12000%E9%9D%A2%E8%AF%95/12005Spring%E4%BA%8B%E5%8A%A1%E5%A4%B1%E6%95%886%E7%A7%8D%E5%9C%BA%E6%99%AF/">Spring事务失效6种场景</a></h1><div class="content"><h1 id="Spring事务失效6种场景"><a href="#Spring事务失效6种场景" class="headerlink" title="Spring事务失效6种场景"></a>Spring事务失效6种场景</h1><h2 id="1-方法的访问类型不是public（JDK动态代理无法访问）"><a href="#1-方法的访问类型不是public（JDK动态代理无法访问）" class="headerlink" title="1.方法的访问类型不是public（JDK动态代理无法访问）"></a>1.方法的访问类型不是public（JDK动态代理无法访问）</h2><h2 id="2-类没有被Spring管理"><a href="#2-类没有被Spring管理" class="headerlink" title="2.类没有被Spring管理"></a>2.类没有被Spring管理</h2><h2 id="3-抛出的异常被捕获"><a href="#3-抛出的异常被捕获" class="headerlink" title="3.抛出的异常被捕获"></a>3.抛出的异常被捕获</h2><h2 id="4-方法中的调用同一个类中的方法（因为没有使用代理类）"><a href="#4-方法中的调用同一个类中的方法（因为没有使用代理类）" class="headerlink" title="4.方法中的调用同一个类中的方法（因为没有使用代理类）"></a>4.方法中的调用同一个类中的方法（因为没有使用代理类）</h2><h2 id="5-事务的传播行为配置错误"><a href="#5-事务的传播行为配置错误" class="headerlink" title="5.事务的传播行为配置错误"></a>5.事务的传播行为配置错误</h2><h2 id="6-rollbackFor属性配置错误"><a href="#6-rollbackFor属性配置错误" class="headerlink" title="6.rollbackFor属性配置错误"></a>6.rollbackFor属性配置错误</h2><h3 id="Spring的事务机制基于什么来实现的？"><a href="#Spring的事务机制基于什么来实现的？" class="headerlink" title="Spring的事务机制基于什么来实现的？"></a>Spring的事务机制基于什么来实现的？</h3><p>事务是通过AOP切面，JDK的动态代理</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/13/12000%E9%9D%A2%E8%AF%95/12004Java%E7%9A%84%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98/"><img class="fill" src="/../../images/cover4.jpg" alt="Java的引用问题"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-13T03:43:11.151Z" title="2022/5/13 上午11:43:11">2022-05-13</time>发表</span><span class="level-item"><time dateTime="2022-05-14T07:58:11.785Z" title="2022/5/14 下午3:58:11">2022-05-14</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">1 分钟读完 (大约137个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/13/12000%E9%9D%A2%E8%AF%95/12004Java%E7%9A%84%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98/">Java的引用问题</a></h1><div class="content"><h1 id="Java的引用问题"><a href="#Java的引用问题" class="headerlink" title="Java的引用问题"></a>Java的引用问题</h1><h2 id="共4种：强软弱虚"><a href="#共4种：强软弱虚" class="headerlink" title="共4种：强软弱虚"></a>共4种：强软弱虚</h2><h2 id="1-强引用"><a href="#1-强引用" class="headerlink" title="1.强引用"></a>1.强引用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br></pre></td></tr></table></figure>

<h2 id="2-软引用"><a href="#2-软引用" class="headerlink" title="2.软引用"></a>2.软引用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -Xms20M -Xmx20M</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>]);<span class="comment">//10M</span></span><br><span class="line">system().gc();	<span class="comment">// 并不会把10M内存回收掉</span></span><br></pre></td></tr></table></figure>

<p>软应用适合缓存使用。堆heap装不下，回收一次，不够把软应用干掉</p>
<p>关联： <a href="../14000JAVA/14002JAVA%E5%9B%9B%E7%A7%8D%E7%BC%93%E5%AD%98.md">JAVA四种缓存</a>  </p>
<h2 id="3-弱引用"><a href="#3-弱引用" class="headerlink" title="3.弱引用"></a>3.弱引用</h2><p>ThreadLocal类中的ThreadLocalMap的key就是弱引用，可参考<a href="./ThreadLocal%E6%BA%90%E7%A0%81.md">ThreadLocal源码</a></p>
<h2 id="4-虚引用"><a href="#4-虚引用" class="headerlink" title="4.虚引用"></a>4.虚引用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">PhantomReference</span>(<span class="keyword">new</span> <span class="title class_">M</span>(), Queue);</span><br></pre></td></tr></table></figure>

<p>虚引用回收被放入Queue队列中</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12003ThreadLocal%E6%BA%90%E7%A0%81/"><img class="fill" src="/../../images/cover3.jpg" alt="ThreadLocal源码介绍"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-12T06:50:12.571Z" title="2022/5/12 下午2:50:12">2022-05-12</time>发表</span><span class="level-item"><time dateTime="2022-05-12T08:22:24.102Z" title="2022/5/12 下午4:22:24">2022-05-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">3 分钟读完 (大约471个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12003ThreadLocal%E6%BA%90%E7%A0%81/">ThreadLocal源码介绍</a></h1><div class="content"><h1 id="ThreadLocal源码理解"><a href="#ThreadLocal源码理解" class="headerlink" title="ThreadLocal源码理解"></a>ThreadLocal源码理解</h1><h2 id="1-为什么需要ThreadLocal？"><a href="#1-为什么需要ThreadLocal？" class="headerlink" title="1.为什么需要ThreadLocal？"></a>1.为什么需要ThreadLocal？</h2><p>答：可以解决多线程共享变量的问题，每个线程中都会有ThreadLocalMap变量，Map的key就是threadLocal当前对象，value就是存入的值。来避免线程不安全的问题。</p></div><a class="article-more button is-small is-size-7" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12003ThreadLocal%E6%BA%90%E7%A0%81/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12002%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/"><img class="fill" src="/../../images/cover2.jpg" alt="内存分配"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-11T16:16:28.365Z" title="2022/5/12 上午12:16:28">2022-05-12</time>发表</span><span class="level-item"><time dateTime="2022-05-12T08:21:15.788Z" title="2022/5/12 下午4:21:15">2022-05-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">几秒读完 (大约14个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12002%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">内存分配</a></h1><div class="content"><h1 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xkVxRqVTgdff5zE-kwMnLA">https://mp.weixin.qq.com/s/xkVxRqVTgdff5zE-kwMnLA</a></p></div><a class="article-more button is-small is-size-7" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12002%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12001%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/"><img class="fill" src="/../../images/cover1.jpg" alt="常见限流算法"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-05-11T16:02:44.782Z" title="2022/5/12 上午12:02:44">2022-05-12</time>发表</span><span class="level-item"><time dateTime="2022-05-12T08:21:18.599Z" title="2022/5/12 下午4:21:18">2022-05-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">2 分钟读完 (大约319个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12001%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/">常见限流算法</a></h1><div class="content"><h1 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h1><p>为什么需要限流算法？避免在流量高峰的生活导致系统被压垮，造成系统不可用的问题。</p></div><a class="article-more button is-small is-size-7" href="/2022/05/12/12000%E9%9D%A2%E8%AF%95/12001%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/05/18/14000JAVA/14001%20%E9%9D%A2%E8%AF%95%E5%AE%98%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BB%8E10%E4%BA%BF%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%9F/"><img class="fill" src="/../../images/cover1.jpg" alt="面试官：如何从10亿数据中快速判断是否存在某一个元素？"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-18T06:52:33.000Z" title="2021/5/18 下午2:52:33">2021-05-18</time>发表</span><span class="level-item"><time dateTime="2022-05-12T06:49:47.023Z" title="2022/5/12 下午2:49:47">2022-05-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span><span class="level-item">22 分钟读完 (大约3259个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/18/14000JAVA/14001%20%E9%9D%A2%E8%AF%95%E5%AE%98%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BB%8E10%E4%BA%BF%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%9F/">面试官：如何从10亿数据中快速判断是否存在某一个元素？</a></h1><div class="content"><h1 id="2-8-1-面试官：如何从10亿数据中快速判断是否存在某一个元素？"><a href="#2-8-1-面试官：如何从10亿数据中快速判断是否存在某一个元素？" class="headerlink" title="2.8.1 面试官：如何从10亿数据中快速判断是否存在某一个元素？"></a>2.8.1 面试官：如何从10亿数据中快速判断是否存在某一个元素？</h1><h2 id="1-缓存雪崩"><a href="#1-缓存雪崩" class="headerlink" title="1 缓存雪崩"></a>1 缓存雪崩</h2><p>缓存雪崩指的是 Redis 当中的大量缓存在同一时间全部失效，而假如恰巧这一段时间同时又有大量请求被发起，那么就会造成请求直接访问到数据库，可能会把数据库冲垮。</p>
<p>缓存雪崩一般形容的是缓存中没有而数据库中有的数据，而因为时间到期导致请求直达数据库。</p></div><a class="article-more button is-small is-size-7" href="/2021/05/18/14000JAVA/14001%20%E9%9D%A2%E8%AF%95%E5%AE%98%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BB%8E10%E4%BA%BF%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%9F/#more">阅读更多</a></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Tonygeli"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Tonygeli</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>SH</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">159</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">30</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/tonygeli" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux%E5%91%BD%E4%BB%A4/"><span class="level-start"><span class="level-item">Linux命令</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringBoot/"><span class="level-start"><span class="level-item">SpringBoot</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="level-start"><span class="level-item">中间件</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/"><span class="level-start"><span class="level-item">时间管理</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%93%E5%AD%98/"><span class="level-start"><span class="level-item">缓存</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">网络</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AF%BB%E4%B9%A6/"><span class="level-start"><span class="level-item">读书</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Bean/"><span class="tag">Bean</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CPU%E6%8C%87%E6%A0%87/"><span class="tag">CPU指标</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Icarus/"><span class="tag">Icarus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySql/"><span class="tag">MySql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Netty/"><span class="tag">Netty</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Stream/"><span class="tag">Stream</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TCP/"><span class="tag">TCP</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZooKeeper/"><span class="tag">ZooKeeper</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8B%E5%8A%A1/"><span class="tag">事务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/"><span class="tag">代码优化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="tag">公众号</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/"><span class="tag">内存分配</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="tag">分布式事务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/"><span class="tag">分布式缓存</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"><span class="tag">单点登录</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A0%86%E7%BC%93%E5%AD%98/"><span class="tag">堆缓存</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"><span class="tag">大数据</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B9%B6%E5%8F%91/"><span class="tag">并发</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%95%E7%94%A8/"><span class="tag">引用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E9%94%81/"><span class="tag">死锁</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E7%A8%8B/"><span class="tag">线程</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D/"><span class="tag">自动装配</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%99%90%E6%B5%81/"><span class="tag">限流</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-16T10:18:24.850Z">2022-05-16</time></p><p class="title"><a href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12008%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%80%9A%E8%AE%AF/">线程之间如何进行通讯</a></p><p class="categories"><a href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-16T10:14:45.012Z">2022-05-16</time></p><p class="title"><a href="/2022/05/16/12000%E9%9D%A2%E8%AF%95/12007%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E6%AD%BB%E9%94%81/">如何查看线程死锁</a></p><p class="categories"><a href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-15T15:22:11.939Z">2022-05-15</time></p><p class="title"><a href="/2022/05/15/12000%E9%9D%A2%E8%AF%95/12006CPU%E8%BF%87%E9%AB%98%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5/">CPU过高如何排查</a></p><p class="categories"><a href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-15T14:58:58.764Z">2022-05-15</time></p><p class="title"><a href="/2022/05/15/13000Linux/13003Linux%E5%91%BD%E4%BB%A4df/">Linux命令df</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-15T12:24:37.230Z">2022-05-15</time></p><p class="title"><a href="/2022/05/15/14000JAVA/14003LongAdder/">LongAdder</a></p><p class="categories"><a href="/categories/JAVA/">JAVA</a></p></div></article></div></div><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="LILAIQUN" height="28"></a><p class="is-size-7"><span>&copy; 2022 Tonygeli</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>